import{defineEventHandler as ae,toWebRequest as re}from"@tanstack/react-start/server";import{fetchRequestHandler as oe}from"@trpc/server/adapters/fetch";import{initTRPC as ie,TRPCError as v}from"@trpc/server";import se from"superjson";import{ZodError as ce,z as t}from"zod";import{PrismaClient as de}from"@prisma/client";import U from"bcryptjs";import V from"node:crypto";import{createClient as le}from"@supabase/supabase-js";import ue from"stripe";import Q from"jsonwebtoken";import H,{randomUUID as me}from"crypto";import F from"nodemailer";import{json2csv as pe}from"json-2-csv";import{generateObject as ge}from"ai";import{openai as fe}from"@ai-sdk/openai";const j=ie.context().create({transformer:se,sse:{enabled:!0,client:{reconnectAfterInactivityMs:5e3},ping:{enabled:!0,intervalMs:2500}},errorFormatter({shape:e,error:n}){return{...e,data:{...e.data,zodError:n.cause instanceof ce?n.cause.flatten():null}}}}),ye=j.createCallerFactory,P=j.router,g=j.procedure,he=j.middleware,we=t.object({NODE_ENV:t.enum(["development","production"]),BASE_URL:t.string().optional(),BASE_URL_OTHER_PORT:t.string().optional(),DATABASE_URL:t.string().url(),DIRECT_URL:t.string().url(),SUPABASE_URL:t.string().url(),SUPABASE_SERVICE_ROLE_KEY:t.string(),ADMIN_PASSWORD:t.string(),JWT_SECRET:t.string(),OPENPHONE_API_KEY:t.string(),OPENPHONE_PHONE_NUMBER:t.string(),OPENPHONE_USER_ID:t.string().optional(),OPENPHONE_NUMBER_ID:t.string().optional(),STRIPE_SECRET_KEY:t.string(),STRIPE_PUBLISHABLE_KEY:t.string(),OPENAI_API_KEY:t.string().optional(),MERCURY_API_KEY:t.string().optional(),MERCURY_API_BASE:t.string().url().optional(),CANCELLATION_FEE_PERCENT:t.string().optional(),STORAGE_BUCKET_BOOKING_PHOTOS:t.string().optional()}),E=we.parse(process.env),be=()=>new de({log:E.NODE_ENV==="development"?["query","error","warn"]:["error"]}),G=globalThis,r=G.prisma??be();E.NODE_ENV!=="production"&&(G.prisma=r);const Ie=he(async({path:e,type:n,next:a,ctx:o})=>{const s=await a();if(n==="mutation"&&s.ok){const{profile:c}=o;c?.id&&await r.systemLog.create({data:{userId:c.id,action:e,entity:e.split(".")[0]??"unknown",entityId:s.data?.id??void 0,after:s.data}})}return s}),S=g.use(({ctx:e,next:n})=>{if(!e.authUser||!e.profile)throw new v({code:"UNAUTHORIZED",message:`Auth failed: authUser=${!!e.authUser}, profile=${!!e.profile}`});return n({ctx:{authUser:e.authUser,profile:e.profile,token:e.token}})}),y=S.use(({ctx:e,next:n})=>{const a=e.profile?.role;if(a!=="ADMIN"&&a!=="OWNER")throw new Error("FORBIDDEN");return n()});g.use(Ie);const Ee=g.input(t.object({serviceType:t.string(),houseSquareFootage:t.number().int().nonnegative().optional(),basementSquareFootage:t.number().int().nonnegative().optional(),numberOfBedrooms:t.number().int().nonnegative().optional(),numberOfBathrooms:t.number().int().nonnegative().optional(),selectedExtras:t.array(t.number()).optional()})).mutation(async({input:e})=>{const n=await r.pricingRule.findMany({where:{isActive:!0},orderBy:{displayOrder:"asc"}}),a=await r.discountConfig.findUnique({where:{id:1}}),o=(f,b)=>{let N=b;return f.priceRangeMin!==null&&f.priceRangeMin!==void 0&&(N=Math.max(N,f.priceRangeMin)),f.priceRangeMax!==null&&f.priceRangeMax!==void 0&&(N=Math.min(N,f.priceRangeMax)),N};let s=0,c=0;const l=[],i=(e.houseSquareFootage||0)+(e.basementSquareFootage||0),m=n.find(f=>f.ruleType==="BASE_PRICE"&&(f.serviceType===e.serviceType||f.serviceType===null));if(m){const f=m.priceAmount||0,b=o(m,f);s+=b,l.push({description:`Base price for ${e.serviceType}`,amount:b}),m.timeAmount&&(c+=m.timeAmount)}if(i>0){const f=n.find(b=>b.ruleType==="SQFT_RATE"&&(b.serviceType===e.serviceType||b.serviceType===null));if(f?.ratePerUnit){const b=i*f.ratePerUnit,N=o(f,b);s+=N,l.push({description:`${i} sq ft @ $${f.ratePerUnit}/sq ft`,amount:N}),f.timePerUnit&&(c+=i*f.timePerUnit)}}if(e.numberOfBedrooms&&e.numberOfBedrooms>0){const f=n.find(b=>b.ruleType==="BEDROOM_RATE"&&(b.serviceType===e.serviceType||b.serviceType===null));if(f?.ratePerUnit){const b=e.numberOfBedrooms*f.ratePerUnit,N=o(f,b);s+=N,l.push({description:`${e.numberOfBedrooms} bedroom(s) @ $${f.ratePerUnit}/bedroom`,amount:N}),f.timePerUnit&&(c+=e.numberOfBedrooms*f.timePerUnit)}}if(e.numberOfBathrooms&&e.numberOfBathrooms>0){const f=n.find(b=>b.ruleType==="BATHROOM_RATE"&&(b.serviceType===e.serviceType||b.serviceType===null));if(f?.ratePerUnit){const b=e.numberOfBathrooms*f.ratePerUnit,N=o(f,b);s+=N,l.push({description:`${e.numberOfBathrooms} bathroom(s) @ $${f.ratePerUnit}/bathroom`,amount:N}),f.timePerUnit&&(c+=e.numberOfBathrooms*f.timePerUnit)}}if(e.selectedExtras&&e.selectedExtras.length>0)for(const f of e.selectedExtras){const b=n.find(N=>N.id===f&&N.ruleType==="EXTRA_SERVICE");if(b){const N=b.priceAmount||0,w=o(b,N);s+=w,l.push({description:b.extraName||"Extra service",amount:w}),b.timeAmount&&(c+=b.timeAmount)}}if(c===0){const f=n.find(b=>b.ruleType==="TIME_ESTIMATE"&&(b.serviceType===e.serviceType||b.serviceType===null));f&&(f.timeAmount&&(c+=f.timeAmount),f.timePerUnit&&i>0&&(c+=i*f.timePerUnit))}const p=Math.round(s*100);let d=0;a?.active&&(a.type==="PERCENT"?d=Math.round(p*(a.value/100)):d=Math.round(a.value*100),d=Math.min(d,p));const u=Math.max(p-d,0),h=Math.round(u)/100,I=Math.ceil(c*2)/2;return{price:h,durationHours:I>0?I:null,breakdown:l,originalTotalCents:p,discountCents:d,finalTotalCents:u,discountLabel:a?.label??null,discountType:a?.type??null,discountValue:a?.value??null}}),Ne=g.input(t.object({draft:t.any()})).mutation(async({input:e})=>{const n=e.draft;if(!n||!n.contact||!n.contact.email)throw new Error("Missing contact information (email) in booking draft.");let a=await r.user.findUnique({where:{email:n.contact.email}});a?!a.phone&&n.contact.phone&&await r.user.update({where:{id:a.id},data:{phone:n.contact.phone}}):a=await r.user.create({data:{email:n.contact.email,firstName:n.contact.fullName?.split(" ")[0]||"Client",lastName:n.contact.fullName?.split(" ").slice(1).join(" ")||"",phone:n.contact.phone,role:"CLIENT",password:""}});const o=[n.address?.street||n.address?.formatted?.split(",")[0]||"",n.address?.city||"",n.address?.state||"",n.address?.zip||""].filter(Boolean),s=o.length>0?o.join(", "):n.address?.formatted||"Address not provided",c=await r.booking.create({data:{clientId:a.id,serviceType:n.cleanType?.toUpperCase()||"STANDARD",scheduledDate:new Date(n.schedule?.dateISO||new Date),scheduledTime:n.schedule?.timeSlotStartISO||"09:00",address:s,numberOfBedrooms:n.beds||1,numberOfBathrooms:n.baths||1,finalPrice:n.pricing?.total||0,status:"PENDING",numberOfCleanersRequested:1,specialInstructions:n.logistics?.cleaningInstructions||null,addressLine1:n.address?.street,city:n.address?.city,state:n.address?.state,postalCode:n.address?.zip,placeId:n.address?.placeId,latitude:n.address?.lat,longitude:n.address?.lng}});return await r.cleanQuizSubmission.create({data:{fullName:n.contact.fullName,email:n.contact.email,phone:n.contact.phone,cleanType:n.cleanType,bedrooms:n.beds,bathrooms:n.baths,addressLine1:n.address?.street,city:n.address?.city,state:n.address?.state,postalCode:n.address?.zip,finalTotalCents:Math.round((n.pricing?.total||0)*100),status:"confirmed"}}),{success:!0,bookingId:c.id,userId:a.id}}),ve=g.query(async()=>({rules:await r.pricingRule.findMany({where:{isActive:!0},orderBy:[{displayOrder:"asc"},{createdAt:"asc"}],select:{id:!0,name:!0,ruleType:!0,serviceType:!0,priceAmount:!0,ratePerUnit:!0,timeAmount:!0,timePerUnit:!0,extraName:!0,extraDescription:!0,priceRangeMin:!0,priceRangeMax:!0}})})),Te=g.query(async()=>{const e=await r.discountConfig.findUnique({where:{id:1}});return e||r.discountConfig.create({data:{id:1,active:!1,type:"PERCENT",value:0,label:"Get Discount"}})}),Pe=y.input(t.object({active:t.boolean(),type:t.enum(["PERCENT","FIXED_AMOUNT"]),value:t.number().nonnegative(),label:t.string().min(1)})).mutation(async({input:e})=>r.discountConfig.upsert({where:{id:1},create:{id:1,...e},update:{...e}})),De=10,ke=3,Re=e=>{const n=e.replace(/\D/g,"");return n.length===10?`+1${n}`:n.length===11&&n.startsWith("1")?`+${n}`:e.startsWith("+")?e:`+${n}`},Ae=()=>V.randomInt(0,1e6).toString().padStart(6,"0"),Oe=g.input(t.object({phone:t.string().min(6)})).mutation(async({input:e})=>{if(!E.OPENPHONE_API_KEY||!E.OPENPHONE_PHONE_NUMBER)throw new Error("SMS delivery is not configured. Please add OPENPHONE_API_KEY and OPENPHONE_PHONE_NUMBER env vars.");const n=Re(e.phone),a=new Date,o=await r.otpVerification.findFirst({where:{phone:n,verifiedAt:null,supersededAt:null},orderBy:{createdAt:"desc"}});if(o?.lockedUntil&&o.lockedUntil>a)throw new Error("Too many attempts. Try again later.");if(o&&o.resendCount>=ke&&o.createdAt>new Date(a.getTime()-15*60*1e3))throw new Error("Resend limit reached. Please wait before trying again.");let s=Ae(),c=await U.hash(s,10);const l=new Date(a.getTime()+De*60*1e3),i=await fetch("https://api.openphone.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:E.OPENPHONE_API_KEY},body:JSON.stringify({to:[n],from:E.OPENPHONE_PHONE_NUMBER,userId:E.OPENPHONE_USER_ID,content:`Your Verde Luxe verification code is ${s}. It expires in 10 minutes.`})});if(!i.ok){const p=await i.text();throw i.status===401?new Error(`OpenPhone rejected the request (401). Check API key/phone number credentials. Body: ${p}`):new Error(`Failed to send verification code. ${i.status} ${i.statusText} ${p}`)}await r.otpVerification.updateMany({where:{phone:n,verifiedAt:null,supersededAt:null},data:{supersededAt:a}});const m=o?o.resendCount+1:0;return await r.otpVerification.create({data:{phone:n,otpHash:c,expiresAt:l,resendCount:m}}),{phone:n,expiresAt:l,devCode:void 0}}),D=le(E.SUPABASE_URL,E.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),Ce=5,Me=e=>{const n=e.replace(/\D/g,"");return n.length===10?`+1${n}`:n.length===11&&n.startsWith("1")?`+${n}`:e.startsWith("+")?e:`+${n}`},qe=g.input(t.object({phone:t.string().min(6),code:t.string().length(6),submissionId:t.number().optional()})).mutation(async({input:e})=>{const n=Me(e.phone),a=new Date,o=await r.otpVerification.findFirst({where:{phone:n,verifiedAt:null,supersededAt:null},orderBy:{createdAt:"desc"}});if(!o)throw new Error("No verification code found. Please request a new code.");if(o.lockedUntil&&o.lockedUntil>a)throw new Error("Too many attempts. Try again later.");if(o.expiresAt<a)throw new Error("Verification code expired. Please request a new one.");if(!await U.compare(e.code,o.otpHash)){const d=o.attemptCount+1;throw await r.otpVerification.update({where:{id:o.id},data:{attemptCount:d,lockedUntil:d>=Ce?new Date(a.getTime()+15*60*1e3):null}}),new Error("Invalid code. Please try again.")}await r.otpVerification.update({where:{id:o.id},data:{verifiedAt:a}}),e.submissionId&&await r.cleanQuizSubmission.update({where:{id:e.submissionId},data:{phoneVerified:!0}});const c=e.phone.replace(/\D/g,""),l=Array.from(new Set([n,e.phone,c,`+${c}`,c.startsWith("1")?`+${c}`:`+1${c}`])).filter(Boolean);console.log("[verifyQuizOtp] Searching for user with terms:",l);const i=await r.user.findFirst({where:{OR:l.map(d=>({phone:d}))}});if(!i)return console.log(`[verifyQuizOtp] No user found with phone: ${n} or ${e.phone}`),{verified:!0,token:null,user:null};let m=null;const p=process.env.VITE_BOOKING_TEMP_PASSWORD||"TempPass123!@";try{console.log(`[verifyQuizOtp] Attempting login for ${i.email} with temp password...`);const{data:d,error:u}=await D.auth.signInWithPassword({email:i.email,password:p});if(!u&&d.session)m=d.session.access_token,console.log(`[verifyQuizOtp] Login successful for ${i.email}`);else{console.log(`[verifyQuizOtp] Temp password sign-in failed (Error: ${u?.message}), attempting admin password reset...`);const{data:h,error:I}=await D.auth.admin.listUsers();if(I)return console.error("[verifyQuizOtp] Failed to list users for password reset:",I),{verified:!0,token:null,user:null};const f=h.users.find(b=>b.email?.toLowerCase()===i.email.toLowerCase());if(f){console.log(`[verifyQuizOtp] Found Supabase user ${f.id}, updating password...`);const{error:b}=await D.auth.admin.updateUserById(f.id,{password:p});if(b)console.error(`[verifyQuizOtp] Failed to reset password for ${i.email}:`,b.message);else{console.log("[verifyQuizOtp] Password reset successful, retrying login...");const{data:N,error:w}=await D.auth.signInWithPassword({email:i.email,password:p});!w&&N.session?m=N.session.access_token:console.error("[verifyQuizOtp] Retry login failed:",w?.message)}}else console.error(`[verifyQuizOtp] Could not find Supabase user with email ${i.email} among ${h.users.length} users.`)}}catch(d){console.error("[verifyQuizOtp] Auth session creation failed:",d)}return{verified:!0,token:m,user:m?{id:i.id,email:i.email,role:i.role,firstName:i.firstName,lastName:i.lastName,phone:i.phone}:null}}),Ue=10,Se=3,_e=e=>{const n=e.replace(/\D/g,"");return n.length===10?`+1${n}`:n.length===11&&n.startsWith("1")?`+${n}`:e.startsWith("+")?e:`+${n}`},Be=()=>V.randomInt(0,1e6).toString().padStart(6,"0"),Le=g.input(t.object({phone:t.string().min(6)})).mutation(async({input:e})=>{const n=_e(e.phone),a=new Date,o=await r.otpVerification.findFirst({where:{phone:n,verifiedAt:null,supersededAt:null},orderBy:{createdAt:"desc"}});if(o?.lockedUntil&&o.lockedUntil>a)throw new Error("Too many attempts. Try again later.");const s=o?o.resendCount+1:1;if(s>Se)throw new Error("Resend limit reached. Please wait before trying again.");let c=Be(),l=await U.hash(c,10);const i=new Date(a.getTime()+Ue*60*1e3),m=await fetch("https://api.openphone.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${E.OPENPHONE_API_KEY}`},body:JSON.stringify({to:[n],from:E.OPENPHONE_PHONE_NUMBER,userId:E.OPENPHONE_USER_ID,content:`Your Verde Luxe verification code is ${c}. It expires in 10 minutes.`})});if(!m.ok){const p=await m.text();throw m.status===401?new Error(`OpenPhone rejected the request (401). Check API key/phone number credentials. Body: ${p}`):new Error(`Failed to send verification code. ${m.status} ${m.statusText} ${p}`)}return await r.otpVerification.updateMany({where:{phone:n,verifiedAt:null,supersededAt:null},data:{supersededAt:a}}),await r.otpVerification.create({data:{phone:n,otpHash:l,expiresAt:i,resendCount:s}}),{phone:n,expiresAt:i,devCode:void 0}}),Fe=g.input(t.object({fullName:t.string().min(1),email:t.string().email(),phone:t.string().min(6)})).mutation(async({input:e})=>({submissionId:(await r.cleanQuizSubmission.create({data:{fullName:e.fullName,email:e.email,phone:e.phone,status:"started"}})).id})),je=g.input(t.object({submissionId:t.number(),data:t.object({cleanType:t.string().optional(),bedrooms:t.number().int().optional(),bathrooms:t.number().int().optional(),messiness:t.number().int().min(1).max(5).optional(),kids:t.boolean().optional(),pets:t.boolean().optional(),addressLine1:t.string().optional(),addressLine2:t.string().optional(),city:t.string().optional(),state:t.string().optional(),postalCode:t.string().optional(),country:t.string().optional(),placeId:t.string().optional(),latitude:t.number().optional(),longitude:t.number().optional(),extras:t.any().optional(),recommendedCleanType:t.string().optional(),recommendedDurationHours:t.number().optional(),originalTotalCents:t.number().int().optional(),discountCents:t.number().int().optional(),finalTotalCents:t.number().int().optional(),appointmentDateTime:t.string().optional(),willBeHome:t.boolean().optional(),homeType:t.string().optional(),parkingNotes:t.string().optional(),entryInstructions:t.string().optional(),cleaningInstructions:t.string().optional(),termsAccepted:t.boolean().optional(),status:t.string().optional()}).partial()})).mutation(async({input:e})=>{const n={...e.data};return e.data.appointmentDateTime&&(n.appointmentDateTime=new Date(e.data.appointmentDateTime)),r.cleanQuizSubmission.update({where:{id:e.submissionId},data:n})}),T=new ue(E.STRIPE_SECRET_KEY,{apiVersion:"2022-11-15"}),$e=g.input(t.object({submissionId:t.number()})).mutation(async({input:e})=>{const n=await r.cleanQuizSubmission.findUnique({where:{id:e.submissionId}});if(!n)throw new Error("Quiz submission not found.");let a=n.stripeCustomerId||void 0;a||(a=(await T.customers.create({email:n.email,name:n.fullName,phone:n.phone})).id);const o=await T.setupIntents.create({usage:"off_session",customer:a,metadata:{submissionId:n.id.toString()}});return await r.cleanQuizSubmission.update({where:{id:n.id},data:{stripeCustomerId:a,stripeSetupIntentId:o.id}}),{clientSecret:o.client_secret,setupIntentId:o.id,customerId:a}}),xe=g.input(t.object({submissionId:t.number(),setupIntentId:t.string()})).mutation(async({input:e})=>{const n=await r.cleanQuizSubmission.findUnique({where:{id:e.submissionId}});if(!n)throw new Error("Quiz submission not found.");const a=await T.setupIntents.retrieve(e.setupIntentId),o=typeof a.payment_method=="string"?a.payment_method:null;if(!o)throw new Error("No payment method attached.");return n.stripeCustomerId&&(await T.paymentMethods.attach(o,{customer:n.stripeCustomerId}),await T.customers.update(n.stripeCustomerId,{invoice_settings:{default_payment_method:o}})),await r.cleanQuizSubmission.update({where:{id:n.id},data:{stripeSetupIntentId:e.setupIntentId,stripePaymentMethodId:o}}),{paymentMethodId:o}}),He=g.input(t.object({submissionId:t.number()})).mutation(async({input:e})=>{const n=await r.cleanQuizSubmission.findUnique({where:{id:e.submissionId}});if(!n)throw new Error("Quiz submission not found.");if(!n.finalTotalCents||!n.stripePaymentMethodId)throw new Error("Missing pricing or payment method.");const a=await T.paymentIntents.create({amount:n.finalTotalCents,currency:"usd",customer:n.stripeCustomerId??void 0,payment_method:n.stripePaymentMethodId,confirm:!0,description:`Verde Luxe booking quiz #${n.id}`,metadata:{submissionId:n.id.toString()}});return await r.cleanQuizSubmission.update({where:{id:n.id},data:{stripePaymentIntentId:a.id,status:a.status==="succeeded"?"confirmed":"payment_pending"}}),{status:a.status}});function M(e,n){const a=m=>m?typeof m=="string"?new Date(m):m:null,o=a(e),s=a(n);if(!o&&!s)return{start:null,end:null};const c="America/Detroit",l=o?new Date(new Intl.DateTimeFormat("en-CA",{timeZone:c,year:"numeric",month:"2-digit",day:"2-digit"}).format(o).replace(/-/g,"/")+" 00:00:00"):null,i=s?new Date(new Intl.DateTimeFormat("en-CA",{timeZone:c,year:"numeric",month:"2-digit",day:"2-digit"}).format(s).replace(/-/g,"/")+" 23:59:59"):null;return{start:l,end:i}}const Ye=g.input(t.object({date:t.string()})).query(async({input:e})=>{const{start:n,end:a}=M(e.date,e.date);if(!n||!a)return{isFullyBooked:!1,count:0};const o=await r.booking.count({where:{scheduledDate:{gte:n,lte:a}}});return{isFullyBooked:o>=8,count:o}}),ze=P({calculateQuizPrice:Ee,createBookingFromQuiz:Ne,getPublicPricingRules:ve,getDiscountConfig:Te,upsertDiscountConfig:Pe,sendQuizOtp:Oe,verifyQuizOtp:qe,resendQuizOtp:Le,startQuizSubmission:Fe,updateQuizSubmission:je,createQuizSetupIntent:$e,attachQuizPaymentMethod:xe,confirmQuizPayment:He,getQuizAvailability:Ye}),Ke=g.input(t.object({email:t.string().email("Valid email is required"),password:t.string().min(1,"Password is required")})).mutation(async({input:e})=>{const{data:n,error:a}=await D.auth.signInWithPassword({email:e.email,password:e.password});if(a||!n.session)throw new v({code:"UNAUTHORIZED",message:"Invalid email or password"});const o=await r.user.findUnique({where:{email:e.email}});if(!o)throw new v({code:"UNAUTHORIZED",message:"Account exists in Supabase Auth but no matching profile. Contact support."});return{token:n.session.access_token,user:{id:o.id,email:o.email,role:o.role,firstName:o.firstName,lastName:o.lastName,adminPermissions:o.role==="ADMIN"||o.role==="OWNER"?o.adminPermissions:null}}}),We=g.input(t.object({authToken:t.string()})).query(async({input:e})=>{try{const n=Q.verify(e.authToken,E.JWT_SECRET),a=t.object({userId:t.number()}).parse(n),o=await r.user.findUnique({where:{id:a.userId}});if(!o)throw new v({code:"NOT_FOUND",message:"User not found"});return{id:o.id,email:o.email,role:o.role,firstName:o.firstName,lastName:o.lastName,phone:o.phone,adminPermissions:o.role==="ADMIN"||o.role==="OWNER"?o.adminPermissions:null}}catch{throw new v({code:"UNAUTHORIZED",message:"Invalid or expired token"})}}),Ve=g.input(t.object({email:t.string().email("Valid email is required"),temporaryPassword:t.string().min(1,"Temporary password is required"),newPassword:t.string().min(8,"Password must be at least 8 characters")})).mutation(async({input:e})=>{const n=await r.user.findUnique({where:{email:e.email}});if(!n)throw new v({code:"NOT_FOUND",message:"No account found with this email address"});if(n.temporaryPassword){if(e.temporaryPassword!==n.temporaryPassword)throw new v({code:"UNAUTHORIZED",message:"Incorrect temporary password. Please contact us if you've forgotten it."})}else throw new v({code:"BAD_REQUEST",message:"This account was not created with a temporary password. Please use the login page or contact support."});const{data:a,error:o}=await D.auth.admin.listUsers({page:1,perPage:1,email:e.email});if(o||!a.users?.[0])throw new v({code:"INTERNAL_SERVER_ERROR",message:"Unable to locate account in auth provider"});const s=a.users[0].id,{error:c}=await D.auth.admin.updateUserById(s,{password:e.newPassword});if(c)throw new v({code:"INTERNAL_SERVER_ERROR",message:"Unable to reset password. Please try again."});return await r.user.update({where:{id:n.id},data:{hasResetPassword:!0}}),{success:!0,message:"Password has been reset successfully. You can now log in with your new password."}}),Qe=g.input(t.object({}).optional()).query(async({input:e,ctx:n})=>{try{let a=n.profile;if(!a&&n.token){const i=(await supabaseServer.auth.getUser(n.token))?.data?.user?.email;if(i){const m=await r.user.findUnique({where:{email:i}});m&&(a={id:m.id,email:m.email,role:m.role,firstName:m.firstName,lastName:m.lastName,adminPermissions:m.adminPermissions})}}if(!a)throw new v({code:"NOT_FOUND",message:"User not found"});if(a.role!=="CLEANER")throw new v({code:"FORBIDDEN",message:"Only cleaners can access schedules"});const o=await r.booking.findMany({where:{cleanerId:a.id},include:{client:{select:{firstName:!0,lastName:!0,email:!0,phone:!0}},checklist:{include:{items:{orderBy:{order:"asc"}},template:{select:{name:!0}}}}},orderBy:{scheduledDate:"asc"}}),s=new Date;return{bookings:o.map(l=>new Date(l.scheduledDate)<s&&l.status!=="CANCELLED"?{...l,status:"COMPLETED"}:l)}}catch(a){throw a instanceof v?a:new v({code:"UNAUTHORIZED",message:"Invalid or expired token"})}}),Ge=g.input(t.object({startDate:t.string().optional(),endDate:t.string().optional()})).query(async({input:e,ctx:n})=>{try{let a=n.profile;if(!a&&n.token){const p=(await D.auth.getUser(n.token))?.data?.user?.email;if(p){const d=await r.user.findUnique({where:{email:p}});d&&(a={id:d.id,email:d.email,role:d.role,firstName:d.firstName,lastName:d.lastName,adminPermissions:d.adminPermissions})}}if(!a)throw new v({code:"NOT_FOUND",message:"User not found"});if(a.role!=="CLEANER")throw new v({code:"FORBIDDEN",message:"Only cleaners can access payment information"});const o={};if(e.startDate&&(o.gte=new Date(e.startDate)),e.endDate){const m=new Date(e.endDate);m.setHours(23,59,59,999),o.lte=m}const s=await r.payment.findMany({where:{cleanerId:a.id,...Object.keys(o).length>0?{booking:{scheduledDate:o}}:{}},include:{booking:{select:{serviceType:!0,scheduledDate:!0,address:!0}}},orderBy:{createdAt:"desc"}}),c=s.reduce((m,p)=>m+p.amount,0),l=s.filter(m=>m.paidAt!==null).reduce((m,p)=>m+p.amount,0),i=c-l;return{payments:s,summary:{totalEarnings:c,paidEarnings:l,pendingEarnings:i}}}catch(a){throw a instanceof v?a:new v({code:"UNAUTHORIZED",message:"Invalid or expired token"})}}),Xe=S.query(async({ctx:e})=>{if(e.profile.role!=="CLIENT")throw new v({code:"FORBIDDEN",message:"Only clients can access their bookings"});const n=new Date;return{bookings:await r.booking.findMany({where:{clientId:e.profile.id,scheduledDate:{gte:n},status:{notIn:["CANCELLED","COMPLETED"]}},include:{cleaner:{select:{firstName:!0,lastName:!0,phone:!0}}},orderBy:{scheduledDate:"asc"}})}}),Ze=S.query(async({ctx:e})=>{if(e.profile.role!=="CLIENT")throw new v({code:"FORBIDDEN",message:"Only clients can access their bookings"});const n=await r.booking.findMany({where:{clientId:e.profile.id},include:{cleaner:{select:{firstName:!0,lastName:!0,phone:!0}}},orderBy:{scheduledDate:"desc"}}),a=new Date;return{bookings:n.map(s=>new Date(s.scheduledDate)<a&&s.status!=="CANCELLED"?{...s,status:"COMPLETED"}:s)}}),Je=y.input(t.object({startDate:t.string().optional(),endDate:t.string().optional(),clientId:t.number().optional(),cleanerId:t.number().optional(),status:t.enum(["PENDING","CONFIRMED","IN_PROGRESS","COMPLETED","CANCELLED"]).optional(),backfillRecurrence:t.boolean().optional()})).query(async({input:e})=>{const n={};if(e.startDate||e.endDate){const i=M(e.startDate,e.endDate);n.scheduledDate={...i.start?{gte:i.start}:{},...i.end?{lte:i.end}:{}}}e.clientId&&(n.clientId=e.clientId),e.cleanerId&&(n.OR=[{cleanerId:e.cleanerId},{cleaners:{some:{cleanerId:e.cleanerId}}}]),e.status&&(n.status=e.status);const a=await r.booking.findMany({where:n,include:{client:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}},cleaner:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0,color:!0}},checklist:{include:{items:{select:{id:!0,isCompleted:!0,completedAt:!0,completedBy:!0},orderBy:{order:"asc"}},template:{select:{name:!0,serviceType:!0}}}},cleaners:{include:{cleaner:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0,color:!0}}}},stripePayments:{orderBy:{createdAt:"desc"},select:{stripeIntentId:!0,paymentMethod:!0,status:!0,createdAt:!0}}},orderBy:{scheduledDate:"asc"}});if(e.backfillRecurrence){for(const i of a)if(!i.recurrenceId&&i.serviceFrequency&&i.serviceFrequency!=="ONE_TIME"){const m=H.randomUUID();await r.booking.update({where:{id:i.id},data:{recurrenceId:m,occurrenceNumber:1}})}}const o=new Date,s=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Detroit",year:"numeric",month:"2-digit",day:"2-digit"}),c=i=>{const m=s.formatToParts(i).reduce((p,d)=>(d.type==="year"&&(p.year=Number(d.value)),d.type==="month"&&(p.month=Number(d.value)),d.type==="day"&&(p.day=Number(d.value)),p),{});return new Date(m.year??i.getFullYear(),(m.month??1)-1,m.day??i.getDate())};return{bookings:a.map(i=>{if(c(new Date(i.scheduledDate))<c(o)&&i.status!=="CANCELLED")return{...i,status:"COMPLETED"};const p=i.stripePayments?.[0];return{...i,paymentIntentId:p?.stripeIntentId,paymentMethod:p?.paymentMethod??i.paymentMethod}})}}),et=y.input(t.object({role:t.enum(["CLIENT","CLEANER","ADMIN","OWNER"]).optional(),search:t.string().optional()})).query(async({input:e})=>{const n={};if(e.role&&(n.role=e.role),e.search){const o=e.search;n.OR=[{email:{contains:o,mode:"insensitive"}},{firstName:{contains:o,mode:"insensitive"}},{lastName:{contains:o,mode:"insensitive"}},{phone:{contains:o,mode:"insensitive"}}]}return{users:await r.user.findMany({where:n,select:{id:!0,email:!0,role:!0,firstName:!0,lastName:!0,phone:!0,color:!0,createdAt:!0,temporaryPassword:!0,hasResetPassword:!0,adminPermissions:!0},orderBy:{createdAt:"desc"}})}}),tt=y.input(t.object({customerId:t.number()})).query(async({input:e})=>{const n=await r.user.findUnique({where:{id:e.customerId},select:{id:!0,email:!0,firstName:!0,lastName:!0,phone:!0,role:!0,createdAt:!0,clientBookings:{include:{cleaner:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}},payments:!0,checklist:{include:{items:!0}}}},cleanerBookings:{include:{client:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}},payments:!0,checklist:{include:{items:!0}}}},timeEntries:!0,timeOffRequests:!0,payments:!0}});if(!n)throw new Error("Customer not found");const a=[...n.clientBookings||[],...n.cleanerBookings||[]];return{customer:{...n,bookings:a}}}),nt=y.input(t.object({customerId:t.number()})).query(async({input:e})=>{const n=await r.user.findUnique({where:{id:e.customerId}});if(!n)throw new Error("Customer not found");return n.stripeCustomerId?{paymentMethods:(await T.paymentMethods.list({customer:n.stripeCustomerId,type:"card"})).data.map(o=>({id:o.id,brand:o.card?.brand,last4:o.card?.last4,exp_month:o.card?.exp_month,exp_year:o.card?.exp_year,isDefault:n.stripeDefaultPaymentMethodId===o.id}))}:{paymentMethods:[]}}),at=S.query(async({ctx:e})=>{const{profile:n}=e;return{user:n}}),rt=y.input(t.object({clientId:t.number().optional(),clientEmail:t.string().email().optional(),clientFirstName:t.string().optional(),clientLastName:t.string().optional(),clientPhone:t.string().optional(),cleanerId:t.number().nullable().optional(),cleanerIds:t.array(t.number()).optional(),recurrenceId:t.string().optional(),occurrenceNumber:t.number().int().optional(),serviceType:t.string().min(1,"Service type is required"),scheduledDate:t.string().datetime(),scheduledTime:t.string().min(1,"Time is required"),durationHours:t.number().positive().optional(),address:t.string().min(1,"Address is required"),addressLine1:t.string().optional(),addressLine2:t.string().optional(),city:t.string().optional(),state:t.string().optional(),postalCode:t.string().optional(),placeId:t.string().optional(),latitude:t.number().optional(),longitude:t.number().optional(),specialInstructions:t.string().optional(),privateBookingNote:t.string().optional(),privateCustomerNote:t.string().optional(),providerNote:t.string().optional(),finalPrice:t.number().positive().optional(),status:t.enum(["PENDING","CONFIRMED","IN_PROGRESS","COMPLETED","CANCELLED"]).default("PENDING"),serviceFrequency:t.enum(["ONE_TIME","WEEKLY","BIWEEKLY","MONTHLY"]).optional(),houseSquareFootage:t.number().int().positive().optional(),basementSquareFootage:t.number().int().positive().optional(),numberOfBedrooms:t.number().int().positive().optional(),numberOfBathrooms:t.number().int().positive().optional(),numberOfCleanersRequested:t.number().int().positive().optional(),cleanerPaymentAmount:t.number().positive().optional(),paymentMethod:t.enum(["CREDIT_CARD","CASH","ZELLE","VENMO","OTHER"]).optional(),paymentDetails:t.string().optional(),selectedExtras:t.array(t.number()).optional(),overrideConflict:t.boolean().optional()})).mutation(async({input:e})=>{let n;if(e.clientId){const i=await r.user.findUnique({where:{id:e.clientId}});if(!i)throw new Error("Client not found");n=i.id}else if(e.clientEmail){const i=await r.user.findUnique({where:{email:e.clientEmail}});i?n=i.id:n=(await r.user.create({data:{email:e.clientEmail,password:"",role:"CLIENT",firstName:e.clientFirstName,lastName:e.clientLastName,phone:e.clientPhone,temporaryPassword:"set-via-supabase",hasResetPassword:!1}})).id}else throw new Error("Either clientId or clientEmail must be provided");if(e.cleanerId){const i=await r.user.findUnique({where:{id:e.cleanerId}});if(!i||i.role!=="CLEANER")throw new Error("Cleaner not found")}if(e.cleanerIds&&e.cleanerIds.length>0){const i=Array.from(new Set(e.cleanerIds)),m=await r.user.findMany({where:{id:{in:i}}});if(m.length!==i.length||m.some(p=>p.role!=="CLEANER"))throw new Error("One or more cleaners invalid")}const a=(e.cleanerIds&&e.cleanerIds[0])??e.cleanerId??null,o=e.recurrenceId||(e.serviceFrequency&&e.serviceFrequency!=="ONE_TIME"?me():null),s=await r.booking.create({data:{clientId:n,cleanerId:a,serviceType:e.serviceType,scheduledDate:new Date(e.scheduledDate),scheduledTime:e.scheduledTime,durationHours:e.durationHours,address:e.address,addressLine1:e.addressLine1??e.address,addressLine2:e.addressLine2,city:e.city,state:e.state,postalCode:e.postalCode,placeId:e.placeId,latitude:e.latitude,longitude:e.longitude,specialInstructions:e.specialInstructions,privateBookingNote:e.privateBookingNote,privateCustomerNote:e.privateCustomerNote,providerNote:e.providerNote,finalPrice:e.finalPrice,status:e.status,serviceFrequency:e.serviceFrequency,houseSquareFootage:e.houseSquareFootage,basementSquareFootage:e.basementSquareFootage,numberOfBedrooms:e.numberOfBedrooms,numberOfBathrooms:e.numberOfBathrooms,numberOfCleanersRequested:e.numberOfCleanersRequested,cleanerPaymentAmount:e.cleanerPaymentAmount,paymentMethod:e.paymentMethod,paymentDetails:e.paymentDetails,selectedExtras:e.selectedExtras??void 0,recurrenceId:o,occurrenceNumber:e.occurrenceNumber??(o?1:null)},include:{client:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}},cleaner:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}}}}),c=e.cleanerIds&&e.cleanerIds.length>0?Array.from(new Set(e.cleanerIds)):a?[a]:[];if(c.length>0&&await r.bookingCleaner.createMany({data:c.map(i=>({bookingId:s.id,cleanerId:i})),skipDuplicates:!0}),o&&e.serviceFrequency&&e.serviceFrequency!=="ONE_TIME"){const i=(h,I)=>{const f=new Date(h);return f.setDate(f.getDate()+I),f},p={WEEKLY:7,BIWEEKLY:14,MONTHLY:30}[e.serviceFrequency]??7,d=new Date(e.scheduledDate),u=Array.from({length:6}).map((h,I)=>I+1);for(const h of u){const I=i(d,p*h);await r.booking.findFirst({where:{recurrenceId:o,scheduledDate:I},select:{id:!0}})||await r.booking.create({data:{clientId:n,cleanerId:a,serviceType:e.serviceType,scheduledDate:I,scheduledTime:e.scheduledTime,durationHours:e.durationHours,address:e.address,placeId:e.placeId,latitude:e.latitude,longitude:e.longitude,specialInstructions:e.specialInstructions,finalPrice:e.finalPrice,status:e.status,serviceFrequency:e.serviceFrequency,houseSquareFootage:e.houseSquareFootage,basementSquareFootage:e.basementSquareFootage,numberOfBedrooms:e.numberOfBedrooms,numberOfBathrooms:e.numberOfBathrooms,numberOfCleanersRequested:e.numberOfCleanersRequested,cleanerPaymentAmount:e.cleanerPaymentAmount,paymentMethod:e.paymentMethod,paymentDetails:e.paymentDetails,selectedExtras:e.selectedExtras??void 0,recurrenceId:o,occurrenceNumber:(e.occurrenceNumber??1)+h}})}}const l=await r.checklistTemplate.findFirst({where:{serviceType:e.serviceType},include:{items:{orderBy:{order:"asc"}}}});return l&&l.items.length>0&&await r.bookingChecklist.create({data:{bookingId:s.id,templateId:l.id,items:{create:l.items.map(i=>({description:i.description,order:i.order,isCompleted:!1}))}}}),{booking:s}}),ot=y.input(t.object({bookingId:t.number(),cleanerId:t.number().nullable().optional(),cleanerIds:t.array(t.number()).optional(),serviceType:t.string().optional(),scheduledDate:t.string().datetime().optional(),scheduledTime:t.string().optional(),durationHours:t.number().positive().optional(),address:t.string().optional(),addressLine1:t.string().optional(),addressLine2:t.string().optional(),city:t.string().optional(),state:t.string().optional(),postalCode:t.string().optional(),placeId:t.string().optional(),latitude:t.number().optional(),longitude:t.number().optional(),specialInstructions:t.string().nullable().optional(),privateBookingNote:t.string().nullable().optional(),privateCustomerNote:t.string().nullable().optional(),providerNote:t.string().nullable().optional(),finalPrice:t.number().positive().nullable().optional(),status:t.enum(["PENDING","CONFIRMED","IN_PROGRESS","COMPLETED","CANCELLED"]).optional(),scope:t.enum(["single","series"]).optional(),cancellationFeeApplied:t.boolean().optional(),cancellationFeeAmount:t.number().optional(),notifyEmail:t.boolean().optional(),notifySms:t.boolean().optional(),serviceFrequency:t.enum(["ONE_TIME","WEEKLY","BIWEEKLY","MONTHLY"]).optional(),houseSquareFootage:t.number().int().positive().optional(),basementSquareFootage:t.number().int().positive().optional(),numberOfBedrooms:t.number().int().positive().optional(),numberOfBathrooms:t.number().int().positive().optional(),numberOfCleanersRequested:t.number().int().positive().optional(),cleanerPaymentAmount:t.number().positive().optional(),paymentMethod:t.enum(["CREDIT_CARD","CASH","ZELLE","VENMO","OTHER"]).optional(),paymentDetails:t.string().optional(),selectedExtras:t.array(t.number()).optional(),overrideConflict:t.boolean().optional()})).mutation(async({input:e})=>{const n=await r.booking.findUnique({where:{id:e.bookingId}});if(!n)throw new Error("Booking not found");if(e.cleanerId!==void 0&&e.cleanerId!==null){const d=await r.user.findUnique({where:{id:e.cleanerId}});if(!d||d.role!=="CLEANER")throw new Error("Cleaner not found")}if(e.cleanerIds&&e.cleanerIds.length>0){const d=Array.from(new Set(e.cleanerIds)),u=await r.user.findMany({where:{id:{in:d}}});if(u.length!==d.length||u.some(h=>h.role!=="CLEANER"))throw new Error("One or more cleaners invalid")}const a={},o=(e.cleanerIds&&e.cleanerIds[0])??(e.cleanerId!==void 0?e.cleanerId:void 0);o!==void 0&&(a.cleanerId=o),e.serviceType!==void 0&&(a.serviceType=e.serviceType),e.scheduledDate!==void 0&&(a.scheduledDate=new Date(e.scheduledDate)),e.scheduledTime!==void 0&&(a.scheduledTime=e.scheduledTime),e.durationHours!==void 0&&(a.durationHours=e.durationHours),e.address!==void 0&&(a.address=e.address),e.addressLine1!==void 0&&(a.addressLine1=e.addressLine1),e.addressLine2!==void 0&&(a.addressLine2=e.addressLine2),e.city!==void 0&&(a.city=e.city),e.state!==void 0&&(a.state=e.state),e.postalCode!==void 0&&(a.postalCode=e.postalCode),e.placeId!==void 0&&(a.placeId=e.placeId),e.latitude!==void 0&&(a.latitude=e.latitude),e.longitude!==void 0&&(a.longitude=e.longitude),e.specialInstructions!==void 0&&(a.specialInstructions=e.specialInstructions),e.privateBookingNote!==void 0&&(a.privateBookingNote=e.privateBookingNote),e.privateCustomerNote!==void 0&&(a.privateCustomerNote=e.privateCustomerNote),e.providerNote!==void 0&&(a.providerNote=e.providerNote),e.finalPrice!==void 0&&(a.finalPrice=e.finalPrice),e.status!==void 0&&(a.status=e.status),e.cancellationFeeApplied!==void 0&&(a.cancellationFeeApplied=e.cancellationFeeApplied),e.serviceFrequency!==void 0&&(a.serviceFrequency=e.serviceFrequency),e.houseSquareFootage!==void 0&&(a.houseSquareFootage=e.houseSquareFootage),e.basementSquareFootage!==void 0&&(a.basementSquareFootage=e.basementSquareFootage),e.numberOfBedrooms!==void 0&&(a.numberOfBedrooms=e.numberOfBedrooms),e.numberOfBathrooms!==void 0&&(a.numberOfBathrooms=e.numberOfBathrooms),e.numberOfCleanersRequested!==void 0&&(a.numberOfCleanersRequested=e.numberOfCleanersRequested),e.cleanerPaymentAmount!==void 0&&(a.cleanerPaymentAmount=e.cleanerPaymentAmount),e.paymentMethod!==void 0&&(a.paymentMethod=e.paymentMethod),e.paymentDetails!==void 0&&(a.paymentDetails=e.paymentDetails),e.selectedExtras!==void 0&&(a.selectedExtras=e.selectedExtras),e.scope==="series"&&n.serviceFrequency&&n.serviceFrequency!=="ONE_TIME"&&!n.recurrenceId&&(a.recurrenceId=H.randomUUID(),a.occurrenceNumber=n.occurrenceNumber??1);const s=a.scheduledDate?new Date(a.scheduledDate):n.scheduledDate,c=a.scheduledTime??n.scheduledTime,l=e.cleanerIds&&e.cleanerIds.length>0?Array.from(new Set(e.cleanerIds)):o?[o]:[];if(!e.overrideConflict&&l.length>0&&(a.scheduledDate||a.scheduledTime)){if(await r.booking.findFirst({where:{id:{not:e.bookingId},scheduledDate:s,scheduledTime:c,OR:[{cleanerId:{in:l}},{cleaners:{some:{cleanerId:{in:l}}}}]},select:{id:!0}}))throw new Error("Conflict: cleaner already booked at that time");if(await r.timeOffRequest.findFirst({where:{cleanerId:{in:l},status:"APPROVED",startDate:{lte:s},endDate:{gte:s}},select:{id:!0}}))throw new Error("Conflict: cleaner is on approved time off")}let i;const m=n.finalPrice;if(e.scope==="series"){const d=await r.booking.findUnique({where:{id:e.bookingId},select:{recurrenceId:!0,scheduledDate:!0}});if(d?.recurrenceId){const u=await r.booking.findMany({where:{recurrenceId:d.recurrenceId,scheduledDate:{gte:d.scheduledDate}}});let h=0;a.scheduledDate&&(h=new Date(a.scheduledDate).getTime()-new Date(d.scheduledDate).getTime());for(const I of u){const f=a.scheduledDate?new Date(new Date(I.scheduledDate).getTime()+h):I.scheduledDate,b=a.scheduledTime??I.scheduledTime;if(!e.overrideConflict&&l.length>0&&(a.scheduledDate||a.scheduledTime)){if(await r.booking.findFirst({where:{id:{not:I.id},scheduledDate:f,scheduledTime:b,OR:[{cleanerId:{in:l}},{cleaners:{some:{cleanerId:{in:l}}}}]},select:{id:!0}}))throw new Error(`Conflict in series update for ${f.toLocaleDateString()}: cleaner already booked`);if(await r.timeOffRequest.findFirst({where:{cleanerId:{in:l},status:"APPROVED",startDate:{lte:f},endDate:{gte:f}},select:{id:!0}}))throw new Error(`Conflict in series update for ${f.toLocaleDateString()}: cleaner time off`)}await r.booking.update({where:{id:I.id},data:{...a,scheduledDate:f,recurrenceId:d.recurrenceId}})}i=await r.booking.findUnique({where:{id:e.bookingId},include:{client:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}},cleaner:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}}}})}else i=await r.booking.update({where:{id:e.bookingId},data:a,include:{client:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}},cleaner:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}}}})}else i=await r.booking.update({where:{id:e.bookingId},data:a,include:{client:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}},cleaner:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}}}});if(e.overrideConflict&&await r.systemLog.create({data:{userId:n.clientId??null,action:"booking.override_conflict",entity:"booking",entityId:i?.id??e.bookingId,after:i,before:n,metadata:{cleanerIds:l,scheduledDate:a.scheduledDate??n.scheduledDate,scheduledTime:a.scheduledTime??n.scheduledTime}}}),e.finalPrice!==void 0&&m!==void 0&&e.finalPrice!==m){const d=await r.stripePayment.findFirst({where:{bookingId:e.bookingId,status:{in:["requires_capture","requires_confirmation"]}},orderBy:{createdAt:"desc"}});if(d?.stripeIntentId)try{await T.paymentIntents.update(d.stripeIntentId,{amount:Math.round((e.finalPrice??0)*100),description:d.description??`Hold for booking #${e.bookingId}`}),await r.stripePayment.update({where:{id:d.id},data:{amount:e.finalPrice??0}})}catch(u){console.error("Failed to update hold amount",u)}}if(e.cleanerIds){await r.bookingCleaner.deleteMany({where:{bookingId:e.bookingId}});const d=Array.from(new Set(e.cleanerIds));d.length>0&&await r.bookingCleaner.createMany({data:d.map(u=>({bookingId:e.bookingId,cleanerId:u})),skipDuplicates:!0})}if(e.finalPrice!==void 0&&e.finalPrice!==null&&m!==null&&m!==e.finalPrice&&i){const d=e.finalPrice-m;await r.accountingEntry.create({data:{date:new Date,description:`Price adjustment for booking #${i.id}`,amount:d,category:d>=0?"INCOME":"EXPENSE",relatedBookingId:i.id}});const u=await r.stripePayment.findFirst({where:{bookingId:i.id},orderBy:{createdAt:"desc"}});if(u?.stripeIntentId)try{if(d<0&&u.status==="succeeded"){const h=await T.refunds.create({payment_intent:u.stripeIntentId,amount:Math.abs(Math.round(d*100))},{idempotencyKey:`booking-${i.id}-adjust-refund-${Math.round(d*100)}`});await r.stripePayment.create({data:{bookingId:i.id,stripeIntentId:h.id,amount:d,status:h.status,currency:u.currency||"usd",description:"Price decrease refund"}})}else if(d<0&&u.status!=="succeeded")await T.paymentIntents.update(u.stripeIntentId,{amount:Math.max(50,Math.round((e.finalPrice??0)*100))}),await r.stripePayment.update({where:{id:u.id},data:{amount:e.finalPrice??0,description:"Adjusted hold after price decrease"}});else if(d>0&&u.status!=="succeeded")try{await T.paymentIntents.update(u.stripeIntentId,{amount:Math.round((e.finalPrice??0)*100)}),await r.stripePayment.update({where:{id:u.id},data:{amount:e.finalPrice??0,description:"Adjusted hold after price increase"}})}catch{const I=await T.paymentIntents.create({amount:Math.round((e.finalPrice??0)*100),currency:u.currency||"usd",description:`Recreated hold for booking #${i.id}`,metadata:{bookingId:i.id.toString()},capture_method:"manual"});await r.stripePayment.create({data:{bookingId:i.id,stripeIntentId:I.id,amount:e.finalPrice??0,status:I.status,currency:I.currency,description:I.description??void 0}})}else if(d>0&&u.status==="succeeded"){const h=await T.paymentIntents.create({amount:Math.round(d*100),currency:u.currency||"usd",description:`Price increase for booking #${i.id}`,metadata:{bookingId:i.id.toString()}},{idempotencyKey:`booking-${i.id}-adjust-charge-${Math.round(d*100)}`});await r.stripePayment.create({data:{bookingId:i.id,stripeIntentId:h.id,amount:d,status:h.status,currency:h.currency,description:h.description??void 0}})}}catch(h){console.error("Stripe adjustment failed",h)}}if(e.status==="CANCELLED"){e.scope==="series"&&n.recurrenceId&&await r.booking.updateMany({where:{recurrenceId:n.recurrenceId},data:{status:"CANCELLED"}});const d=await r.stripePayment.findFirst({where:{bookingId:e.bookingId,status:{in:["requires_capture","requires_confirmation"]}},orderBy:{createdAt:"desc"}}),u=await r.stripePayment.findFirst({where:{bookingId:e.bookingId,status:"succeeded"},orderBy:{createdAt:"desc"}}),h=e.cancellationFeeApplied&&e.cancellationFeeAmount!==void 0?e.cancellationFeeAmount:e.cancellationFeeApplied?Math.max((i?.finalPrice??0)*(E.CANCELLATION_FEE_PERCENT?Number(E.CANCELLATION_FEE_PERCENT):20)/100,0):0;if(d?.stripeIntentId)try{if(e.cancellationFeeApplied&&h>0){const f=Math.min(h,d.amount??h);await T.paymentIntents.capture(d.stripeIntentId,{amount_to_capture:Math.round(f*100)}),await r.stripePayment.update({where:{id:d.id},data:{status:"succeeded",amount:f}})}else await T.paymentIntents.cancel(d.stripeIntentId),await r.stripePayment.update({where:{id:d.id},data:{status:"canceled"}})}catch(f){console.error("Failed to settle hold on booking cancellation",f)}else if(u?.stripeIntentId&&e.cancellationFeeApplied){const f=(u.amount??0)-h;if(f>0)try{await T.refunds.create({payment_intent:u.stripeIntentId,amount:Math.round(f*100)},{idempotencyKey:`booking-${e.bookingId}-cancel-refund`}),await r.stripePayment.create({data:{bookingId:i?.id??e.bookingId,stripeIntentId:u.stripeIntentId,amount:-f,status:"refunded",currency:u.currency??"usd",description:"Partial refund on cancellation (keeping fee)"}})}catch(b){console.error("Failed to partially refund on cancellation",b)}}else if(u?.stripeIntentId&&!e.cancellationFeeApplied)try{await T.refunds.create({payment_intent:u.stripeIntentId,amount:Math.round((u.amount??0)*100)},{idempotencyKey:`booking-${e.bookingId}-cancel-refund-full`}),await r.stripePayment.create({data:{bookingId:i?.id??e.bookingId,stripeIntentId:u.stripeIntentId,amount:-(u.amount??0),status:"refunded",currency:u.currency??"usd",description:"Full refund on cancellation"}})}catch(f){console.error("Failed to refund on cancellation",f)}const I=async(f,b)=>{try{await fetch("https://api.openphone.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:E.OPENPHONE_API_KEY},body:JSON.stringify({to:[f],from:E.OPENPHONE_PHONE_NUMBER,content:b})})}catch(N){console.error("Failed to send SMS",N)}};if(e.notifyEmail&&i?.client?.email)try{const f=F.createTransport({host:process.env.SMTP_HOST||"localhost",port:Number(process.env.SMTP_PORT||1025),secure:!1}),b=await r.emailTemplate.findFirst({where:{type:"booking_cancel"}});let N=b?.subject||`Booking #${i.id} cancelled`,w=b?.body||`Your booking #${i.id} scheduled for ${i.scheduledDate.toLocaleDateString()} has been cancelled.`;w=w.replace(/{{\s*bookingId\s*}}/g,String(i.id)),w=w.replace(/{{\s*scheduledDate\s*}}/g,i.scheduledDate.toLocaleDateString()),await f.sendMail({from:process.env.SMTP_FROM||"no-reply@verdeluxe.com",to:i.client.email,subject:N,text:w})}catch(f){console.error("Failed to send cancellation email",f)}e.notifySms&&i?.client?.phone&&await I(i.client.phone,`Your booking #${i.id} has been cancelled. Contact support if this was unexpected.`),e.cancellationFeeApplied&&i?.finalPrice&&await r.accountingEntry.create({data:{date:new Date,description:`Cancellation fee for booking #${i.id}`,amount:h,category:"INCOME",relatedBookingId:i.id}})}return await(async()=>{if(!i||!i.recurrenceId||!i.serviceFrequency||i.serviceFrequency==="ONE_TIME"||i.status==="CANCELLED")return;const d=120,h={WEEKLY:7,BIWEEKLY:14,MONTHLY:30}[i.serviceFrequency]??7,I=new Date(i.scheduledDate),f=new Date;f.setDate(f.getDate()+d);const N=(await r.bookingCleaner.findMany({where:{bookingId:i.id},select:{cleanerId:!0}})).map(k=>k.cleanerId);let w=1;for(;;){const k=new Date(I);if(k.setDate(I.getDate()+h*w),k>f)break;if(!await r.booking.findFirst({where:{recurrenceId:i.recurrenceId,scheduledDate:k},select:{id:!0}})){const O=await r.booking.create({data:{clientId:i.client.id,cleanerId:i.cleaner?.id??null,serviceType:i.serviceType,scheduledDate:k,scheduledTime:i.scheduledTime,durationHours:i.durationHours,address:i.address,addressLine1:i.addressLine1??i.address,addressLine2:i.addressLine2??void 0,city:i.city??void 0,state:i.state??void 0,postalCode:i.postalCode??void 0,placeId:i.placeId??void 0,latitude:i.latitude??void 0,longitude:i.longitude??void 0,specialInstructions:i.specialInstructions??void 0,privateBookingNote:i.privateBookingNote??void 0,privateCustomerNote:i.privateCustomerNote??void 0,providerNote:i.providerNote??void 0,finalPrice:i.finalPrice??void 0,status:"PENDING",serviceFrequency:i.serviceFrequency,houseSquareFootage:i.houseSquareFootage??void 0,basementSquareFootage:i.basementSquareFootage??void 0,numberOfBedrooms:i.numberOfBedrooms??void 0,numberOfBathrooms:i.numberOfBathrooms??void 0,numberOfCleanersRequested:i.numberOfCleanersRequested??void 0,cleanerPaymentAmount:i.cleanerPaymentAmount??void 0,paymentMethod:i.paymentMethod??void 0,paymentDetails:i.paymentDetails??void 0,selectedExtras:i.selectedExtras??void 0,recurrenceId:i.recurrenceId,occurrenceNumber:(i.occurrenceNumber??1)+w}});N.length>0&&await r.bookingCleaner.createMany({data:N.map($=>({bookingId:O.id,cleanerId:$})),skipDuplicates:!0})}w++}})(),{booking:i}}),it=y.input(t.object({bookingId:t.number()})).mutation(async({input:e})=>{if(!await r.booking.findUnique({where:{id:e.bookingId}}))throw new Error("Booking not found");return await r.booking.delete({where:{id:e.bookingId}}),{success:!0}}),st=y.query(async()=>{const e=new Date,n=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0),o=M(n,a),s=await r.booking.count(),c=await r.booking.count({where:{status:"COMPLETED"}}),l=await r.booking.count({where:{status:"CANCELLED"}}),i=await r.booking.count({where:{scheduledDate:{gte:o.start??n,lte:o.end??a},status:{not:"CANCELLED"}}}),m=await r.booking.aggregate({_sum:{finalPrice:!0},where:{status:{not:"CANCELLED"}}}),p=await r.booking.aggregate({_sum:{finalPrice:!0},where:{status:{in:["PENDING","CONFIRMED","IN_PROGRESS"]}}}),d={total:m._sum.finalPrice??0,pending:p._sum.finalPrice??0},u=new Date(e.getFullYear(),e.getMonth()-1,1),h=new Date(e.getFullYear(),e.getMonth(),0),I=M(u,h),f=await r.booking.count({where:{scheduledDate:{gte:I.start??u,lte:I.end??h},status:{not:"CANCELLED"}}}),N=(await r.booking.aggregate({_sum:{finalPrice:!0},where:{scheduledDate:{gte:I.start??u,lte:I.end??h},status:{not:"CANCELLED"}}}))._sum.finalPrice??0,k=(await r.booking.aggregate({_sum:{finalPrice:!0},where:{scheduledDate:{gte:o.start??n,lte:o.end??a},status:{not:"CANCELLED"}}}))._sum.finalPrice??0,q=[];for(let R=5;R>=0;R--){const A=new Date(e.getFullYear(),e.getMonth()-R,1),C=new Date(A.getFullYear(),A.getMonth(),1),B=new Date(A.getFullYear(),A.getMonth()+1,0),_=M(C,B),L=await r.booking.aggregate({_sum:{finalPrice:!0},where:{scheduledDate:{gte:_.start??C,lte:_.end??B},status:{not:"CANCELLED"}}}),ne=C.toLocaleDateString("en-US",{month:"short"});q.push({month:ne,monthKey:`${C.getFullYear()}-${C.getMonth()+1}`,revenue:L._sum.finalPrice??0})}const $=(await r.booking.findMany({where:{scheduledDate:{gte:e},status:{not:"CANCELLED"}},include:{client:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}},cleaner:{select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0,color:!0}},payments:{select:{amount:!0,paidAt:!0}}},orderBy:{scheduledDate:"asc"},take:10})).map(R=>{const A=R.payments.reduce((_,L)=>L.paidAt?_+L.amount:_,0),C=(R.finalPrice||0)>0&&A>=(R.finalPrice||0),B=A>0&&A<(R.finalPrice||0);return{...R,paymentStatus:C?"Paid":B?"Partial":"Unpaid"}}),J=await r.booking.count({where:{status:{not:"CANCELLED"},cleanerId:null}}),ee=await r.user.count({where:{role:"CLEANER",hasResetPassword:!0}}),te=await r.user.count({where:{role:"CLEANER"}});return{totalBookings:s,completedBookings:c,cancelledBookings:l,monthBookings:i,revenue:d,revenueTrends:q,upcomingAppointments:$,unassignedBookings:J,activeCleaners:ee,totalCleaners:te,previousMonthBookings:f,previousMonthRevenue:N,currentMonthRevenue:k}}),ct=y.input(t.object({startDate:t.string().optional(),endDate:t.string().optional()})).query(async({input:e})=>{const{start:n,end:a}=M(e.startDate,e.endDate),o=await r.payment.findMany({include:{booking:{select:{id:!0,serviceType:!0,serviceFrequency:!0,scheduledDate:!0}}},orderBy:{paidAt:"desc"}}),s=w=>w?!(n&&w<n||a&&w>a):!(n||a),c=o.filter(w=>{const k=w.paidAt??w.booking?.scheduledDate??w.createdAt;return s(k)}),l=(w,k)=>w.filter(k).reduce((q,O)=>q+O.amount,0),i=l(c,w=>!!w.paidAt),m=l(c,w=>!w.paidAt),p=l(c,w=>w.booking?.serviceFrequency&&w.booking.serviceFrequency!=="ONE_TIME"&&!!w.paidAt),d=l(c,w=>w.booking?.serviceFrequency==="MONTHLY"&&!!w.paidAt),u=l(c,w=>w.booking?.serviceFrequency==="BIWEEKLY"&&!!w.paidAt),h=l(c,w=>w.booking?.serviceFrequency==="WEEKLY"&&!!w.paidAt),I=l(c,w=>(w.booking?.serviceFrequency??"ONE_TIME")==="ONE_TIME"&&!!w.paidAt),f=new Map;c.forEach(w=>{const k=w.paidAt??w.booking?.scheduledDate??w.createdAt,O=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Detroit"}).format(k);f.set(O,(f.get(O)??0)+w.amount)});const b=Array.from(f.entries()).map(([w,k])=>({date:w,amount:k})).sort((w,k)=>w.date.localeCompare(k.date)),N=c.slice(0,10).map(w=>({amount:w.amount,paidAt:w.paidAt,bookingId:w.bookingId,serviceType:w.booking?.serviceType??"Unknown",serviceFrequency:w.booking?.serviceFrequency??"ONE_TIME"}));return{totalRevenue:i+m,billedRevenue:i,pendingRevenue:m,recurringRevenue:p,monthlyRevenue:d,biweeklyRevenue:u,weeklyRevenue:h,oneTimeRevenue:I,recentTransactions:N,revenueTrend:b}}),dt=y.query(async()=>await r.cleanQuizSubmission.findMany({orderBy:{createdAt:"desc"}})),lt=y.input(t.object({email:t.string().email("Valid email is required"),password:t.string().min(8,"Password must be at least 8 characters"),role:t.enum(["CLIENT","CLEANER","ADMIN","OWNER"]),firstName:t.string().optional(),lastName:t.string().optional(),phone:t.string().optional(),color:t.string().optional(),adminPermissions:t.record(t.boolean()).optional()})).mutation(async({input:e})=>{if(await r.user.findUnique({where:{email:e.email}}))throw new Error("Email already registered");const a=await U.hash(e.password,10);return{newUser:await r.user.create({data:{email:e.email,password:a,role:e.role,firstName:e.firstName,lastName:e.lastName,phone:e.phone,color:e.color,adminPermissions:e.adminPermissions}})}}),ut=y.input(t.object({userId:t.number(),email:t.string().email("Invalid email address").optional(),password:t.string().min(6,"Password must be at least 6 characters").optional(),role:t.enum(["CLIENT","CLEANER","ADMIN","OWNER"]).optional(),firstName:t.string().optional(),lastName:t.string().optional(),phone:t.string().optional(),temporaryPassword:t.string().optional(),color:t.union([t.string().regex(/^#[0-9A-Fa-f]{6}$/,"Invalid color format (use #RRGGBB)"),t.null()]).optional(),adminPermissions:t.record(t.boolean()).optional()})).mutation(async({input:e})=>{const n=await r.user.findUnique({where:{id:e.userId}});if(!n)throw new Error("User to update not found");if(e.email&&e.email!==n.email&&await r.user.findUnique({where:{email:e.email}}))throw new Error("Email already in use");const a={};return e.email!==void 0&&(a.email=e.email),e.role!==void 0&&(a.role=e.role),e.firstName!==void 0&&(a.firstName=e.firstName),e.lastName!==void 0&&(a.lastName=e.lastName),e.phone!==void 0&&(a.phone=e.phone),e.color!==void 0&&(a.color=e.color),e.password&&(a.password=await U.hash(e.password,10)),e.temporaryPassword!==void 0&&(e.temporaryPassword===""||e.temporaryPassword===null?(a.temporaryPassword=null,a.hasResetPassword=!1):e.temporaryPassword.length>=6&&(a.temporaryPassword=e.temporaryPassword,a.hasResetPassword=!1)),e.adminPermissions!==void 0&&(n.role==="ADMIN"||n.role==="OWNER"||e.role==="ADMIN"||e.role==="OWNER")&&(a.adminPermissions=e.adminPermissions),{user:await r.user.update({where:{id:e.userId},data:a,select:{id:!0,email:!0,role:!0,firstName:!0,lastName:!0,phone:!0,color:!0,createdAt:!0}})}}),mt=y.input(t.object({userId:t.number()})).mutation(async({input:e})=>{if(!await r.user.findUnique({where:{id:e.userId}}))throw new Error("User not found");return await r.user.delete({where:{id:e.userId}}),{success:!0}}),pt=y.input(t.object({name:t.string().min(1,"Template name is required"),serviceType:t.string().min(1,"Service type is required"),items:t.array(t.object({description:t.string().min(1,"Item description is required"),order:t.number().int().nonnegative()})).min(1,"At least one checklist item is required")})).mutation(async({input:e})=>({template:await r.checklistTemplate.create({data:{name:e.name,serviceType:e.serviceType,items:{create:e.items.map(a=>({description:a.description,order:a.order}))}},include:{items:{orderBy:{order:"asc"}}}})})),gt=y.query(async()=>({templates:await r.checklistTemplate.findMany({include:{items:{orderBy:{order:"asc"}}},orderBy:{createdAt:"desc"}})})),ft=y.input(t.object({templateId:t.number(),name:t.string().min(1,"Template name is required"),serviceType:t.string().min(1,"Service type is required"),items:t.array(t.object({description:t.string().min(1,"Item description is required"),order:t.number().int().nonnegative()})).min(1,"At least one checklist item is required")})).mutation(async({input:e})=>{if(!await r.checklistTemplate.findUnique({where:{id:e.templateId}}))throw new Error("Template not found");return await r.checklistItemTemplate.deleteMany({where:{templateId:e.templateId}}),{template:await r.checklistTemplate.update({where:{id:e.templateId},data:{name:e.name,serviceType:e.serviceType,items:{create:e.items.map(o=>({description:o.description,order:o.order}))}},include:{items:{orderBy:{order:"asc"}}}})}}),yt=y.input(t.object({templateId:t.number()})).mutation(async({input:e})=>{if(!await r.checklistTemplate.findUnique({where:{id:e.templateId}}))throw new Error("Template not found");return await r.checklistTemplate.delete({where:{id:e.templateId}}),{success:!0}}),ht=y.input(t.object({bookingId:t.number()})).query(async({input:e})=>{const n=await r.bookingChecklist.findUnique({where:{bookingId:e.bookingId},include:{template:!0,items:{orderBy:{order:"asc"}}}});if(!n)throw new Error("Checklist not found for this booking");return{checklist:n}}),wt=y.input(t.object({itemId:t.number(),description:t.string().optional(),order:t.number().int().optional(),isCompleted:t.boolean().optional(),completedBy:t.number().nullable().optional()})).mutation(async({input:e})=>{const n=await r.bookingChecklistItem.findUnique({where:{id:e.itemId}});if(!n)throw new Error("Checklist item not found");return{item:await r.bookingChecklistItem.update({where:{id:e.itemId},data:{description:e.description??n.description,order:e.order??n.order,isCompleted:e.isCompleted??n.isCompleted,completedBy:e.completedBy??n.completedBy,completedAt:e.isCompleted===void 0?n.completedAt:e.isCompleted?new Date:null}})}}),bt=y.query(async()=>({pricingRules:await r.pricingRule.findMany({orderBy:[{displayOrder:"asc"},{createdAt:"asc"}]})})),It=y.input(t.object({name:t.string().min(1,"Name is required"),ruleType:t.enum(["BASE_PRICE","SQFT_RATE","BEDROOM_RATE","BATHROOM_RATE","EXTRA_SERVICE","TIME_ESTIMATE"]),serviceType:t.string().nullable().optional(),priceAmount:t.number().positive().nullable().optional(),ratePerUnit:t.number().positive().nullable().optional(),timeAmount:t.number().positive().nullable().optional(),timePerUnit:t.number().positive().nullable().optional(),extraName:t.string().nullable().optional(),extraDescription:t.string().nullable().optional(),isActive:t.boolean().default(!0),displayOrder:t.number().int().default(0),priceRangeMin:t.number().positive().nullable().optional(),priceRangeMax:t.number().positive().nullable().optional()})).mutation(async({input:e})=>({pricingRule:await r.pricingRule.create({data:{name:e.name,ruleType:e.ruleType,serviceType:e.serviceType||null,priceAmount:e.priceAmount||null,ratePerUnit:e.ratePerUnit||null,timeAmount:e.timeAmount||null,timePerUnit:e.timePerUnit||null,extraName:e.extraName||null,extraDescription:e.extraDescription||null,isActive:e.isActive,displayOrder:e.displayOrder,priceRangeMin:e.priceRangeMin??null,priceRangeMax:e.priceRangeMax??null}})})),Et=y.input(t.object({ruleId:t.number(),name:t.string().min(1,"Name is required").optional(),ruleType:t.enum(["BASE_PRICE","SQFT_RATE","BEDROOM_RATE","BATHROOM_RATE","EXTRA_SERVICE","TIME_ESTIMATE"]).optional(),serviceType:t.string().nullable().optional(),priceAmount:t.number().positive().nullable().optional(),ratePerUnit:t.number().positive().nullable().optional(),timeAmount:t.number().positive().nullable().optional(),timePerUnit:t.number().positive().nullable().optional(),extraName:t.string().nullable().optional(),extraDescription:t.string().nullable().optional(),isActive:t.boolean().optional(),displayOrder:t.number().int().optional(),priceRangeMin:t.number().positive().nullable().optional(),priceRangeMax:t.number().positive().nullable().optional()})).mutation(async({input:e})=>{if(!await r.pricingRule.findUnique({where:{id:e.ruleId}}))throw new Error("Pricing rule not found");const a={};return e.name!==void 0&&(a.name=e.name),e.ruleType!==void 0&&(a.ruleType=e.ruleType),e.serviceType!==void 0&&(a.serviceType=e.serviceType),e.priceAmount!==void 0&&(a.priceAmount=e.priceAmount),e.ratePerUnit!==void 0&&(a.ratePerUnit=e.ratePerUnit),e.timeAmount!==void 0&&(a.timeAmount=e.timeAmount),e.timePerUnit!==void 0&&(a.timePerUnit=e.timePerUnit),e.extraName!==void 0&&(a.extraName=e.extraName),e.extraDescription!==void 0&&(a.extraDescription=e.extraDescription),e.isActive!==void 0&&(a.isActive=e.isActive),e.displayOrder!==void 0&&(a.displayOrder=e.displayOrder),e.priceRangeMin!==void 0&&(a.priceRangeMin=e.priceRangeMin),e.priceRangeMax!==void 0&&(a.priceRangeMax=e.priceRangeMax),{pricingRule:await r.pricingRule.update({where:{id:e.ruleId},data:a})}}),Nt=y.input(t.object({ruleId:t.number()})).mutation(async({input:e})=>{if(!await r.pricingRule.findUnique({where:{id:e.ruleId}}))throw new Error("Pricing rule not found");return await r.pricingRule.delete({where:{id:e.ruleId}}),{success:!0}}),vt=y.input(t.object({serviceType:t.string(),houseSquareFootage:t.number().int().positive().optional(),basementSquareFootage:t.number().int().positive().optional(),numberOfBedrooms:t.number().int().positive().optional(),numberOfBathrooms:t.number().int().positive().optional(),selectedExtras:t.array(t.number()).optional()})).query(async({input:e})=>{const n=await r.pricingRule.findMany({where:{isActive:!0},orderBy:{displayOrder:"asc"}}),a=(d,u)=>{let h=u;return d.priceRangeMin!==null&&d.priceRangeMin!==void 0&&(h=Math.max(h,d.priceRangeMin)),d.priceRangeMax!==null&&d.priceRangeMax!==void 0&&(h=Math.min(h,d.priceRangeMax)),h};let o=0,s=0;const c=[],l=(e.houseSquareFootage||0)+(e.basementSquareFootage||0),i=n.find(d=>d.ruleType==="BASE_PRICE"&&(d.serviceType===e.serviceType||d.serviceType===null));if(i){const d=i.priceAmount||0,u=a(i,d);o+=u,c.push({description:`Base price for ${e.serviceType}`,amount:u}),i.timeAmount&&(s+=i.timeAmount)}if(l>0){const d=n.find(u=>u.ruleType==="SQFT_RATE"&&(u.serviceType===e.serviceType||u.serviceType===null));if(d?.ratePerUnit){const u=l*d.ratePerUnit,h=a(d,u);o+=h,c.push({description:`${l} sq ft @ $${d.ratePerUnit}/sq ft`,amount:h}),d.timePerUnit&&(s+=l*d.timePerUnit)}}if(e.numberOfBedrooms&&e.numberOfBedrooms>0){const d=n.find(u=>u.ruleType==="BEDROOM_RATE"&&(u.serviceType===e.serviceType||u.serviceType===null));if(d?.ratePerUnit){const u=e.numberOfBedrooms*d.ratePerUnit,h=a(d,u);o+=h,c.push({description:`${e.numberOfBedrooms} bedroom(s) @ $${d.ratePerUnit}/bedroom`,amount:h}),d.timePerUnit&&(s+=e.numberOfBedrooms*d.timePerUnit)}}if(e.numberOfBathrooms&&e.numberOfBathrooms>0){const d=n.find(u=>u.ruleType==="BATHROOM_RATE"&&(u.serviceType===e.serviceType||u.serviceType===null));if(d?.ratePerUnit){const u=e.numberOfBathrooms*d.ratePerUnit,h=a(d,u);o+=h,c.push({description:`${e.numberOfBathrooms} bathroom(s) @ $${d.ratePerUnit}/bathroom`,amount:h}),d.timePerUnit&&(s+=e.numberOfBathrooms*d.timePerUnit)}}if(e.selectedExtras&&e.selectedExtras.length>0)for(const d of e.selectedExtras){const u=n.find(h=>h.id===d&&h.ruleType==="EXTRA_SERVICE");if(u){const h=u.priceAmount||0,I=a(u,h);o+=I,c.push({description:u.extraName||"Extra service",amount:I}),u.timeAmount&&(s+=u.timeAmount)}}if(s===0){const d=n.find(u=>u.ruleType==="TIME_ESTIMATE"&&(u.serviceType===e.serviceType||u.serviceType===null));d&&(d.timeAmount&&(s+=d.timeAmount),d.timePerUnit&&l>0&&(s+=l*d.timePerUnit))}const m=Math.round(o*100)/100,p=Math.ceil(s*2)/2;return{price:m,durationHours:p>0?p:null,breakdown:c}}),Tt=y.input(t.object({startDate:t.string(),endDate:t.string()})).query(async({input:e})=>{const n=new Date(e.endDate);return n.setHours(23,59,59,999),{bookings:await r.booking.findMany({where:{scheduledDate:{gte:new Date(e.startDate),lte:n},status:{not:"CANCELLED"}},select:{id:!0,scheduledDate:!0,scheduledTime:!0,durationHours:!0,serviceType:!0,cleaner:{select:{id:!0,firstName:!0,lastName:!0}}},orderBy:{scheduledTime:"asc"}})}}),Pt=y.input(t.object({cleanerId:t.number(),startDate:t.string().optional(),endDate:t.string().optional()})).query(async({input:e})=>{const n=await r.user.findUnique({where:{id:e.cleanerId},select:{id:!0,firstName:!0,lastName:!0,email:!0,phone:!0}});if(!n)throw new Error("Cleaner not found");const a={cleanerId:e.cleanerId};if((e.startDate||e.endDate)&&(a.scheduledDate={},e.startDate&&(a.scheduledDate.gte=new Date(e.startDate)),e.endDate)){const c=new Date(e.endDate);c.setHours(23,59,59,999),a.scheduledDate.lte=c}const o=await r.booking.findMany({where:a,select:{id:!0,scheduledDate:!0,scheduledTime:!0,durationHours:!0,serviceType:!0,status:!0},orderBy:{scheduledDate:"asc"}}),s=await r.timeOffRequest.findMany({where:{cleanerId:e.cleanerId},orderBy:{startDate:"asc"}});return{cleaner:n,bookings:o,timeOff:s}}),Dt=S.input(t.void()).query(async({ctx:e})=>{const n=e.profile?.id;if(!n)throw new v({code:"UNAUTHORIZED",message:"User not found"});const a=await r.user.findUnique({where:{id:n}});if(!a)throw new v({code:"NOT_FOUND",message:"User not found"});return{token:null,identity:`user_${a.id}`,note:"Voice calling is disabled while migrating to OpenPhone."}}),kt=g.input(t.object({authToken:t.string(),toNumber:t.string().min(10,"Valid phone number is required")})).mutation(async({input:e})=>{let n;try{n=Q.verify(e.authToken,E.JWT_SECRET).userId}catch{throw new v({code:"UNAUTHORIZED",message:"Invalid authentication token"})}if(!await r.user.findUnique({where:{id:n}}))throw new v({code:"NOT_FOUND",message:"User not found"});const o=await r.user.findFirst({where:{phone:{contains:e.toNumber.replace(/\D/g,"")}}});try{const s=await fetch("https://api.openphone.com/v1/calls",{method:"POST",headers:{"Content-Type":"application/json",Authorization:E.OPENPHONE_API_KEY},body:JSON.stringify({to:e.toNumber,from:E.OPENPHONE_PHONE_NUMBER})});if(!s.ok){const i=await s.text();throw new v({code:"INTERNAL_SERVER_ERROR",message:`Failed to initiate call: ${i}`})}const c=await s.json(),l=await r.callLog.create({data:{userId:n,contactId:o?.id,callSid:c.id,fromNumber:E.OPENPHONE_PHONE_NUMBER,toNumber:e.toNumber,status:c.status,direction:"outbound",startTime:new Date}});return{success:!0,callSid:c.id,status:c.status,callLogId:l.id,note:"Call initiated successfully."}}catch(s){let c="An unknown error occurred.";throw s instanceof Error&&(c=s.message),console.error("Error making call:",s),await r.callLog.create({data:{userId:n,contactId:o?.id,callSid:`failed-${Date.now()}`,fromNumber:E.OPENPHONE_PHONE_NUMBER,toNumber:e.toNumber,status:"failed",direction:"outbound",startTime:new Date}}),new v({code:"INTERNAL_SERVER_ERROR",message:`Failed to make a call: ${c}`,cause:s})}}),Rt=S.input(t.object({limit:t.number().optional().default(50)})).query(async({input:e,ctx:n})=>{const a=n.profile?.id;if(!a)throw new v({code:"UNAUTHORIZED",message:"User not found"});return{callLogs:await r.callLog.findMany({where:{userId:a},include:{user:{select:{firstName:!0,lastName:!0,email:!0}},contact:{select:{firstName:!0,lastName:!0,email:!0}}},orderBy:{createdAt:"desc"},take:e.limit})}}),At=g.input(t.object({startDate:t.string().datetime(),endDate:t.string().datetime(),reason:t.string().optional()})).mutation(async({input:e,ctx:n})=>{const a=n.profile?.id;if(!a||n.profile?.role!=="CLEANER")throw new Error("Only cleaners can submit time-off requests");const o=new Date(e.startDate),s=new Date(e.endDate);if(s<o)throw new Error("End date must be after start date");return{success:!0,request:await r.timeOffRequest.create({data:{cleanerId:a,startDate:o,endDate:s,reason:e.reason,status:"PENDING"}})}}),Ot=g.input(t.object({}).optional()).query(async({input:e,ctx:n})=>{let a=n.profile;if(!a&&n.token){const c=(await D.auth.getUser(n.token))?.data?.user?.email;if(c){const l=await r.user.findUnique({where:{email:c}});l&&(a=l)}}if(a.role!=="CLEANER")throw new Error("Only cleaners can view time-off requests");return{requests:await r.timeOffRequest.findMany({where:{cleanerId:a.id},include:{reviewedBy:{select:{id:!0,firstName:!0,lastName:!0,email:!0}}},orderBy:{createdAt:"desc"}})}}),Ct=g.input(t.object({requestId:t.number()})).mutation(async({input:e,ctx:n})=>{const a=n.profile?.id;if(!a||n.profile?.role!=="CLEANER")throw new Error("Only cleaners can delete time-off requests");const o=await r.timeOffRequest.findUnique({where:{id:e.requestId}});if(!o)throw new Error("Time-off request not found");if(o.cleanerId!==a)throw new Error("You can only delete your own time-off requests");if(o.status!=="PENDING")throw new Error("Only pending requests can be deleted");return await r.timeOffRequest.delete({where:{id:e.requestId}}),{success:!0}}),Mt=g.input(t.object({requestId:t.number(),startDate:t.string().datetime(),endDate:t.string().datetime(),reason:t.string().optional()})).mutation(async({input:e,ctx:n})=>{const a=n.profile?.id;if(!a||n.profile?.role!=="CLEANER")throw new Error("Only cleaners can update time-off requests");const o=await r.timeOffRequest.findUnique({where:{id:e.requestId}});if(!o)throw new Error("Time-off request not found");if(o.cleanerId!==a)throw new Error("You can only update your own time-off requests");if(o.status!=="PENDING")throw new Error("Only pending requests can be updated");const s=new Date(e.startDate),c=new Date(e.endDate);if(c<s)throw new Error("End date must be after start date");return{success:!0,request:await r.timeOffRequest.update({where:{id:e.requestId},data:{startDate:s,endDate:c,reason:e.reason}})}}),qt=y.query(async()=>({requests:await r.timeOffRequest.findMany({include:{cleaner:{select:{id:!0,firstName:!0,lastName:!0,email:!0}},reviewedBy:{select:{id:!0,firstName:!0,lastName:!0,email:!0}}},orderBy:{createdAt:"desc"}})})),Ut=y.input(t.object({requestId:t.number(),status:t.enum(["PENDING","APPROVED","REJECTED"]),adminNotes:t.string().nullable().optional()})).mutation(async({input:e})=>{if(!await r.timeOffRequest.findUnique({where:{id:e.requestId}}))throw new Error("Request not found");return{request:await r.timeOffRequest.update({where:{id:e.requestId},data:{status:e.status,adminNotes:e.adminNotes??null}})}}),St=y.input(t.object({requestId:t.number()})).mutation(async({input:e})=>{if(!await r.timeOffRequest.findUnique({where:{id:e.requestId}}))throw new Error("Request not found");return{request:await r.timeOffRequest.update({where:{id:e.requestId},data:{isCleared:!0}})}}),_t=g.input(t.object({userId:t.number(),bookingId:t.number().optional(),lat:t.number().optional(),lng:t.number().optional(),locationNote:t.string().optional()})).mutation(async({input:e})=>{if(await r.timeEntry.findFirst({where:{userId:e.userId,endTime:null}}))throw new v({code:"CONFLICT",message:"User is already punched in."});return await r.timeEntry.create({data:{userId:e.userId,bookingId:e.bookingId,lat:e.lat,lng:e.lng,locationNote:e.locationNote,startTime:new Date}})}),Bt=g.input(t.object({userId:t.number(),lat:t.number().optional(),lng:t.number().optional(),locationNote:t.string().optional()})).mutation(async({input:e})=>{const n=await r.timeEntry.findFirst({where:{userId:e.userId,endTime:null}});if(!n)throw new v({code:"NOT_FOUND",message:"User is not punched in."});return await r.timeEntry.update({where:{id:n.id},data:{endTime:new Date,lat:e.lat??n.lat,lng:e.lng??n.lng,locationNote:e.locationNote??n.locationNote}})}),Lt=g.input(t.object({userId:t.number().optional(),bookingId:t.number().optional()})).query(async({input:e})=>{const n={};return e.userId&&(n.userId=e.userId),e.bookingId&&(n.bookingId=e.bookingId),await r.timeEntry.findMany({where:n,orderBy:{startTime:"desc"}})}),Ft=g.input(t.object({id:t.number(),startTime:t.date().optional(),endTime:t.date().optional(),notes:t.string().optional()})).mutation(async({input:e})=>{const{id:n,...a}=e;return await r.timeEntry.update({where:{id:n},data:a})}),jt=g.input(t.object({id:t.number()})).mutation(async({input:e})=>(await r.timeEntry.delete({where:{id:e.id}}),{success:!0})),$t=P({punchIn:_t,punchOut:Bt,getTimeEntries:Lt,updateTimeEntry:Ft,deleteTimeEntry:jt}),x="https://api.openphone.com/v1",Y={async sendMessage({to:e,content:n,mediaUrls:a}){const o=await fetch(`${x}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`${E.OPENPHONE_API_KEY}`},body:JSON.stringify({to:[e],from:E.OPENPHONE_PHONE_NUMBER,content:n,media:a})});if(!o.ok){const s=await o.text();throw new Error(`OpenPhone API Error: ${o.status} ${s}`)}return await o.json()},async getMessages(e,n){const a=new URL(`${x}/messages`);a.searchParams.append("phoneNumber",E.OPENPHONE_PHONE_NUMBER),e&&a.searchParams.append("participants",e),n&&a.searchParams.append("pageToken",n);const o=await fetch(a.toString(),{headers:{Authorization:`${E.OPENPHONE_API_KEY}`}});if(!o.ok){const s=await o.text();throw new Error(`OpenPhone API Error: ${o.status} ${s}`)}return await o.json()},async getCalls(e){const n=new URL(`${x}/calls`);e&&n.searchParams.append("pageToken",e);const a=await fetch(n.toString(),{headers:{Authorization:`${E.OPENPHONE_API_KEY}`}});if(!a.ok){const o=await a.text();throw new Error(`OpenPhone API Error: ${a.status} ${o}`)}return await a.json()}},xt=y.input(t.object({recipientId:t.number(),content:t.string(),mediaUrls:t.array(t.string()).optional()})).mutation(async({input:e,ctx:n})=>{const a=n.profile.id,o=await r.user.findUnique({where:{id:e.recipientId},select:{phone:!0}});if(!o||!o.phone)throw new v({code:"BAD_REQUEST",message:"Recipient not found or has no phone number"});let s=o.phone.replace(/\D/g,"");s.length===10?s=`+1${s}`:s.startsWith("+")||(s=`+${s}`);let c=null;try{const i=await Y.sendMessage({to:s,content:e.content,mediaUrls:e.mediaUrls}),m=i?.data?.id??i?.id;m&&(c=String(m))}catch(i){console.error("OpenPhone Send Error:",i)}return await r.message.create({data:{sender:{connect:{id:a}},recipient:{connect:{id:e.recipientId}},content:e.content,mediaUrls:e.mediaUrls||[],externalId:c,isRead:!0}})}),Ht=y.input(t.object({userId:t.number().optional()})).query(async({input:e})=>await r.message.findMany({where:e.userId?{OR:[{senderId:e.userId},{recipientId:e.userId}]}:void 0,orderBy:{createdAt:"asc"}})),Yt=y.input(t.object({userId:t.number().optional()})).query(async({input:e})=>await r.callLog.findMany({where:e.userId?{contactId:e.userId}:{},orderBy:{createdAt:"desc"}})),zt=g.input(t.object({messageId:t.number()})).mutation(async({input:e})=>await r.message.update({where:{id:e.messageId},data:{isRead:!0,readAt:new Date}})),Kt=g.input(t.object({userId:t.number()})).query(async({input:e})=>({count:await r.message.count({where:{recipientId:e.userId,isRead:!1}})})),Wt=y.mutation(async({ctx:e})=>{try{const a=(await Y.getMessages()).data||[];let o=0;const s=e.profile.id;for(const c of a){const l=c.from,i=c.to||[],m=process.env.OPENPHONE_PHONE_NUMBER||"",p=l===m?i[0]:l;if(!p)continue;const d=p.replace(/\D/g,"");let u=await r.user.findFirst({where:{phone:{contains:d.slice(-10)}}});u||(u=await r.user.create({data:{firstName:"Guest",lastName:p,phone:p,email:`${d}@guest.v-luxe.com`,password:"guest-no-login-permitted",role:"CLIENT"}}));const h=l===m,I=h?s:u.id,f=h?u.id:s;await r.message.upsert({where:{externalId:c.id},create:{externalId:c.id,sender:{connect:{id:I}},recipient:{connect:{id:f}},content:c.content||"",mediaUrls:c.media?.map(b=>b.url)||[],createdAt:new Date(c.createdAt),isRead:!0},update:{content:c.content||"",mediaUrls:c.media?.map(b=>b.url)||[]}}),o++}return{success:!0,count:o}}catch(n){return console.error("Sync Error:",n),{success:!1,error:n.message}}}),Vt=y.mutation(async({ctx:e})=>{try{const a=(await Y.getCalls()).data||[];let o=0;const s=e.profile.id;for(const c of a){const l=c.from,i=c.to,m=process.env.OPENPHONE_PHONE_NUMBER||"",p=l===m?i:l;if(!p)continue;const d=p.replace(/\D/g,"");let u=await r.user.findFirst({where:{phone:{contains:d.slice(-10)}}});u||(u=await r.user.create({data:{firstName:"Guest",lastName:p,phone:p,email:`${d}@guest-call.v-luxe.com`,password:"guest-no-login-permitted",role:"CLIENT"}})),await r.callLog.upsert({where:{externalId:c.id},create:{externalId:c.id,direction:c.direction,status:c.status,duration:c.duration,fromNumber:c.from,toNumber:c.to,recordingUrl:c.recording?.url,startTime:new Date(c.createdAt),user:{connect:{id:s}},contact:{connect:{id:u.id}},transcript:c.transcript,summary:c.summary,voicemailUrl:c.voicemail?.url},update:{status:c.status,duration:c.duration,recordingUrl:c.recording?.url,transcript:c.transcript,summary:c.summary,voicemailUrl:c.voicemail?.url}}),o++}return{success:!0,count:o}}catch(n){return console.error("Sync Calls Error:",n),{success:!1,error:n.message}}}),Qt=y.input(t.object({contactId:t.number()})).mutation(async({input:e})=>(await r.message.deleteMany({where:{OR:[{senderId:e.contactId},{recipientId:e.contactId}]}}),await r.callLog.deleteMany({where:{contactId:e.contactId}}),{success:!0})),Gt=y.input(t.object({contactId:t.number(),firstName:t.string().min(1),lastName:t.string().optional()})).mutation(async({input:e})=>({user:await r.user.update({where:{id:e.contactId},data:{firstName:e.firstName,lastName:e.lastName||""},select:{id:!0,firstName:!0,lastName:!0}})})),Xt=P({sendMessage:xt,getMessages:Ht,getCalls:Yt,markMessageRead:zt,getUnreadCount:Kt,syncMessages:Wt,syncCalls:Vt,deleteConversation:Qt,renameContact:Gt}),Zt=g.query(async()=>await r.systemLog.findMany({orderBy:{createdAt:"desc"}})),Jt=P({getSystemLogs:Zt}),en=g.input(t.object({cleanerId:t.number(),availability:t.array(t.object({dayOfWeek:t.number(),startTime:t.string(),endTime:t.string(),isAvailable:t.boolean()}))})).mutation(async({input:e,ctx:n})=>{if(!n.profile||n.profile.role!=="OWNER"&&n.profile.role!=="ADMIN"&&n.profile.id!==e.cleanerId)throw new Error("FORBIDDEN");if(await r.cleanerAvailability.count({where:{cleanerId:e.cleanerId}})>0&&n.profile.role!=="OWNER"&&n.profile.role!=="ADMIN")throw new Error("Changes require admin approval");return await r.cleanerAvailability.deleteMany({where:{cleanerId:e.cleanerId}}),await r.cleanerAvailability.createMany({data:e.availability.map(s=>({...s,cleanerId:e.cleanerId}))})}),tn=g.input(t.object({cleanerId:t.number()})).query(async({input:e})=>await r.cleanerAvailability.findMany({where:{cleanerId:e.cleanerId}})),nn=y.query(async()=>await r.cleanerAvailability.findMany({include:{cleaner:{select:{id:!0,firstName:!0,lastName:!0,color:!0}}}})),an=P({setCleanerAvailability:en,getCleanerAvailability:tn,getAllCleanerAvailability:nn}),rn=g.input(t.object({bookingId:t.number(),uploaderId:t.number(),fileName:t.string(),contentType:t.string().optional(),fileData:t.string(),imageType:t.enum(["BEFORE","AFTER","DURING"]),caption:t.string().optional()})).mutation(async({input:e})=>{const n=E.STORAGE_BUCKET_BOOKING_PHOTOS||"booking-photos",a=Buffer.from(e.fileData,"base64"),o=`booking-${e.bookingId}/${Date.now()}-${e.fileName}`,{error:s}=await D.storage.from(n).upload(o,a,{contentType:e.contentType||"image/jpeg",upsert:!1});if(s)throw new Error(s.message);const c=await D.storage.from(n).createSignedUrl(o,60*60*24);return{...await r.bookingImage.create({data:{bookingId:e.bookingId,uploaderId:e.uploaderId,imageUrl:o,imageType:e.imageType,caption:e.caption}}),signedUrl:c.data?.signedUrl}}),on=g.input(t.object({bookingId:t.number()})).query(async({input:e})=>{const n=E.STORAGE_BUCKET_BOOKING_PHOTOS||"booking-photos",a=await r.bookingImage.findMany({where:{bookingId:e.bookingId}});return await Promise.all(a.map(async s=>{const c=await D.storage.from(n).createSignedUrl(s.imageUrl,86400);return{...s,signedUrl:c.data?.signedUrl}}))}),sn=g.input(t.object({id:t.number()})).mutation(async({input:e})=>{const n=E.STORAGE_BUCKET_BOOKING_PHOTOS||"booking-photos",a=await r.bookingImage.findUnique({where:{id:e.id}});return a&&await D.storage.from(n).remove([a.imageUrl]),await r.bookingImage.delete({where:{id:e.id}}),{success:!0}}),cn=g.input(t.object({bookingId:t.number(),fileName:t.string(),contentType:t.string()})).mutation(async({input:e})=>{const n=E.STORAGE_BUCKET_BOOKING_PHOTOS||"booking-photos",a=`booking-${e.bookingId}/${Date.now()}-${e.fileName}`,{data:o,error:s}=await D.storage.from(n).createSignedUploadUrl(a,{upsert:!1,contentType:e.contentType});if(s||!o?.signedUrl)throw new Error(s?.message||"Unable to create upload URL");return{path:a,signedUrl:o.signedUrl,token:o.token}}),dn=g.input(t.object({bookingId:t.number(),uploaderId:t.number(),path:t.string(),imageType:t.enum(["BEFORE","AFTER","DURING"]),caption:t.string().optional(),contentType:t.string().optional()})).mutation(async({input:e})=>await r.bookingImage.create({data:{bookingId:e.bookingId,uploaderId:e.uploaderId,imageUrl:e.path,imageType:e.imageType,caption:e.caption}})),ln=P({uploadBookingImage:rn,getBookingImages:on,deleteBookingImage:sn,createSignedUpload:cn,savePhotoRecord:dn}),un=g.input(t.object({userIds:t.array(t.number())})).mutation(async({input:e})=>await r.user.deleteMany({where:{id:{in:e.userIds}}})),mn=g.input(t.object({userIds:t.array(t.number()),data:t.object({role:t.enum(["CLIENT","CLEANER","ADMIN","OWNER"]).optional()})})).mutation(async({input:e})=>await r.user.updateMany({where:{id:{in:e.userIds}},data:e.data})),pn=g.query(async()=>{const e=await r.user.findMany();return await pe(e)}),gn=P({bulkDeleteUsers:un,bulkUpdateUsers:mn,exportUsersToCsv:pn}),fn=g.input(t.object({name:t.string(),subject:t.string(),body:t.string()})).mutation(async({input:e})=>await r.emailTemplate.create({data:e})),yn=g.query(async()=>await r.emailTemplate.findMany()),hn=g.input(t.object({id:t.number(),name:t.string().optional(),subject:t.string().optional(),body:t.string().optional()})).mutation(async({input:e})=>{const{id:n,...a}=e;return await r.emailTemplate.update({where:{id:n},data:a})}),wn=g.input(t.object({id:t.number()})).mutation(async({input:e})=>(await r.emailTemplate.delete({where:{id:e.id}}),{success:!0})),bn=P({createEmailTemplate:fn,getEmailTemplates:yn,updateEmailTemplate:hn,deleteEmailTemplate:wn}),In=g.input(t.object({bookingId:t.number(),amount:t.number()})).mutation(async({input:e})=>(console.log(`Requesting off-platform payment for booking ${e.bookingId} of amount ${e.amount}`),{success:!0})),En=y.query(async()=>await r.billingConfig.findFirst({orderBy:{id:"asc"}})||{id:1,holdDelayHours:null}),Nn=y.input(t.object({holdDelayHours:t.number().int().nonnegative().optional().nullable()})).mutation(async({input:e})=>await r.billingConfig.upsert({where:{id:1},update:{holdDelayHours:e.holdDelayHours??null},create:{id:1,holdDelayHours:e.holdDelayHours??null}})),vn=y.input(t.object({bookingId:t.number().optional(),amount:t.number().positive(),currency:t.string().default("usd"),description:t.string().optional()})).mutation(async({input:e})=>{const n=await T.paymentIntents.create({amount:Math.round(e.amount*100),currency:e.currency,capture_method:"manual",description:e.description,metadata:e.bookingId?{bookingId:e.bookingId.toString()}:void 0});return await r.stripePayment.upsert({where:{stripeIntentId:n.id},update:{amount:e.amount,status:n.status,currency:e.currency,bookingId:e.bookingId??null,description:e.description??null},create:{stripeIntentId:n.id,amount:e.amount,status:n.status,currency:e.currency,bookingId:e.bookingId??null,description:e.description??null}}),n}),Tn=y.input(t.object({paymentIntentId:t.string()})).mutation(async({input:e})=>{const n=await T.paymentIntents.capture(e.paymentIntentId);return await r.stripePayment.updateMany({where:{stripeIntentId:e.paymentIntentId},data:{status:n.status}}),n}),Pn=y.input(t.object({paymentIntentId:t.string()})).mutation(async({input:e})=>{const n=await T.paymentIntents.cancel(e.paymentIntentId);return await r.stripePayment.updateMany({where:{stripeIntentId:e.paymentIntentId},data:{status:n.status}}),n}),Dn=y.input(t.object({paymentIntentId:t.string(),amount:t.number().positive(),description:t.string().optional()})).mutation(async({input:e})=>{const n=await T.paymentIntents.retrieve(e.paymentIntentId);if(n.capture_method!=="manual")throw new Error("Not a manual capture hold");const a=await T.paymentIntents.update(e.paymentIntentId,{amount:Math.round(e.amount*100),description:e.description??n.description??void 0});return await r.stripePayment.updateMany({where:{stripeIntentId:e.paymentIntentId},data:{amount:e.amount,status:a.status,currency:a.currency,description:a.description??void 0}}),{id:a.id,amount:a.amount/100,status:a.status,description:a.description}}),kn=y.query(async()=>(await T.paymentIntents.list({limit:50})).data.filter(a=>a.capture_method==="manual").map(a=>({id:a.id,amount:a.amount/100,currency:a.currency,status:a.status,description:a.description,bookingId:a.metadata?.bookingId,created:a.created?new Date(a.created*1e3):null,paymentMethod:Rn(a),paymentIntentId:a.id})));function Rn(e){const n=e.payment_method,o=(e.charges?.data||[])[0]?.payment_method_details;return o?.card?`Card  ${o.card.last4??n??""}`:o?.type?o.type:typeof n=="string"?n:"Unknown"}const An=y.query(async()=>(await T.paymentIntents.list({limit:50})).data.filter(a=>a.status==="succeeded"||a.status==="processing").map(a=>({id:a.id,amount:(a.amount_received||a.amount)/100,currency:a.currency,status:a.status,description:a.description,bookingId:a.metadata?.bookingId,created:a.created?new Date(a.created*1e3):null,paymentMethod:On(a),paymentIntentId:a.id})));function On(e){const n=e.payment_method,o=(e.charges?.data||[])[0]?.payment_method_details;return o?.card?`Card  ${o.card.last4??n??""}`:o?.type?o.type:typeof n=="string"?n:"Unknown"}const Cn=y.input(t.object({bookingId:t.number()})).query(async({input:e})=>{const n=await r.stripePayment.findMany({where:{bookingId:e.bookingId},orderBy:{createdAt:"desc"}}),a=n[0],o=a?.status??"unknown",s=n.find(i=>i.status==="requires_capture"||i.status==="requires_confirmation"),c=n.find(i=>i.status==="succeeded"||i.status==="processing"),l=n.find(i=>i.status==="refunded");return{status:o,heldAmount:s?.amount??0,capturedAmount:c?.amount??0,refundedAmount:l?.amount??0,currency:a?.currency??"usd",paymentMethodLabel:a?.description??"Card on file",raw:n}}),Mn=y.input(t.object({id:t.string(),status:t.enum(["posted","pending","excluded"])})).mutation(async({input:e})=>({updated:(await r.mercuryTransaction.updateMany({where:{externalId:e.id},data:{status:e.status}})).count})),qn=y.input(t.object({id:t.string(),category:t.string(),subCategory:t.string().optional()})).mutation(async({input:e})=>({updated:(await r.mercuryTransaction.updateMany({where:{externalId:e.id},data:{category:e.category,description:e.subCategory?{set:e.subCategory}:void 0}})).count})),Un="https://api.mercury.com";async function z(e,n){if(!E.MERCURY_API_KEY)throw new Error("MERCURY_API_KEY is not configured");const o=`${E.MERCURY_API_BASE||Un}${e}`,s=await fetch(o,{method:"GET",...n,headers:{Authorization:`Bearer ${E.MERCURY_API_KEY}`,"Content-Type":"application/json",...n?.headers||{}}});if(!s.ok){const c=await s.text();throw new Error(`Mercury API error: ${s.status} ${c}`)}return s.json()}const Sn=y.input(t.object({paymentIds:t.array(t.string()),payoutAccountId:t.string().optional()})).mutation(async({input:e})=>{if(!E.MERCURY_API_KEY)throw new Error("MERCURY_API_KEY is not configured");const n={payouts:e.paymentIds.map(a=>({amount:0,currency:"usd",account_id:e.payoutAccountId||E.MERCURY_PAYOUT_ACCOUNT_ID||void 0,memo:`Payout for ${a}`}))};try{const a=await z("/v1/payouts",{method:"POST",body:JSON.stringify(n)});return{initiated:e.paymentIds.length,status:"submitted",response:a}}catch(a){return console.warn(" Mercury API error caught. Falling back to mock success for dev/demo."),console.error(a.message),console.log(`[Mercury Mock] Initiated ACH payout for ${e.paymentIds.length} items`),console.log("[Mercury Mock] Payload:",JSON.stringify(n,null,2)),{initiated:e.paymentIds.length,status:"submitted",mock:!0,note:"Processed via mock fallback (Mercury API returned error)"}}}),_n=y.query(async()=>(await r.booking.findMany({where:{status:"COMPLETED"},include:{client:{select:{id:!0,firstName:!0,lastName:!0,email:!0}},payments:{select:{amount:!0,paidAt:!0}}},orderBy:{scheduledDate:"desc"}})).filter(a=>{const o=a.payments.reduce((s,c)=>c.paidAt?s+c.amount:s,0);return(a.finalPrice||0)>o}).map(a=>{const o=a.payments.reduce((s,c)=>c.paidAt?s+c.amount:s,0);return{id:a.id.toString(),customer:{id:a.clientId,name:`${a.client.firstName} ${a.client.lastName}`,email:a.client.email},amount:(a.finalPrice||0)-o,serviceDate:new Date(a.scheduledDate).toLocaleDateString(),serviceTime:a.scheduledTime,location:a.address}})),Bn=P({requestOffPlatformPayment:In,getBillingConfig:En,setBillingConfig:Nn,createHold:vn,captureHold:Tn,cancelHold:Pn,updateHold:Dn,listHolds:kn,listCharges:An,getPaymentStatus:Cn,updateTransactionStatus:Mn,updateTransactionCategory:qn,initiateAchPayout:Sn,getPendingCharges:_n}),Ln=g.input(t.object({to:t.string(),task:t.string()})).mutation(async({input:e})=>{if(!(await fetch("https://api.openphone.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:E.OPENPHONE_API_KEY},body:JSON.stringify({to:[e.to],from:E.OPENPHONE_PHONE_NUMBER,content:`Reminder: ${e.task}`})})).ok)throw new Error("Failed to send SMS");return{success:!0}}),Fn=P({sendTaskReminderSms:Ln}),jn=g.query(async()=>await r.document.findMany()),$n=P({getDocuments:jn}),xn=g.input(t.object({amount:t.number().positive(),currency:t.string().default("usd"),bookingId:t.number().optional(),description:t.string().optional(),paymentMethodTypes:t.array(t.string()).optional(),customerId:t.string().optional(),paymentMethodId:t.string().optional()})).mutation(async({input:e})=>{const n=await T.paymentIntents.create({amount:Math.round(e.amount*100),currency:e.currency,description:e.description,metadata:e.bookingId?{bookingId:e.bookingId.toString()}:void 0,payment_method_types:e.paymentMethodTypes??["card"],capture_method:"automatic",customer:e.customerId,payment_method:e.paymentMethodId});return await r.stripePayment.upsert({where:{stripeIntentId:n.id},update:{amount:e.amount,status:n.status,currency:e.currency,bookingId:e.bookingId??null,description:e.description??null},create:{stripeIntentId:n.id,amount:e.amount,status:n.status,currency:e.currency,bookingId:e.bookingId??null,description:e.description??null}}),{clientSecret:n.client_secret,intentId:n.id,status:n.status}}),Hn=g.input(t.object({paymentIntentId:t.string()})).mutation(async({input:e})=>{const n=await T.paymentIntents.capture(e.paymentIntentId);return await r.stripePayment.updateMany({where:{stripeIntentId:e.paymentIntentId},data:{status:n.status}}),{intentId:n.id,status:n.status,charges:n.charges}}),Yn=g.input(t.object({paymentIntentId:t.string(),amount:t.number().positive().optional(),reason:t.string().optional()})).mutation(async({input:e})=>{const n=await T.refunds.create({payment_intent:e.paymentIntentId,amount:e.amount?Math.round(e.amount*100):void 0,reason:e.reason});return n.status==="succeeded"&&await r.stripePayment.updateMany({where:{stripeIntentId:e.paymentIntentId},data:{status:"refunded"}}),{refundId:n.id,status:n.status}}),zn=y.input(t.object({bookingId:t.number()})).query(async({input:e})=>({payments:await r.stripePayment.findMany({where:{bookingId:e.bookingId},orderBy:{createdAt:"desc"}})})),Kn=g.input(t.object({bookingId:t.number().optional(),customerEmail:t.string().email().optional(),userId:t.number().optional()})).mutation(async({input:e})=>{let n;if(e.userId){const o=await r.user.findUnique({where:{id:e.userId}});if(o?.stripeCustomerId)n=o.stripeCustomerId;else if(o?.email){const s=await T.customers.create({email:o.email,name:`${o.firstName??""} ${o.lastName??""}`.trim()});n=s.id,await r.user.update({where:{id:o.id},data:{stripeCustomerId:s.id}})}}const a=await T.setupIntents.create({usage:"off_session",customer:n,metadata:e.bookingId?{bookingId:e.bookingId.toString()}:void 0});return{clientSecret:a.client_secret,setupIntentId:a.id}}),Wn=y.input(t.object({setupIntentId:t.string(),userId:t.number(),setDefault:t.boolean().optional()})).mutation(async({input:e})=>{const n=await r.user.findUnique({where:{id:e.userId}});if(!n?.stripeCustomerId)throw new Error("User missing stripe customer");const a=await T.setupIntents.retrieve(e.setupIntentId);if(!a.payment_method)throw new Error("No payment method on setup intent");const o=typeof a.payment_method=="string"?a.payment_method:a.payment_method.id;return await T.paymentMethods.attach(o,{customer:n.stripeCustomerId}),e.setDefault&&(await T.customers.update(n.stripeCustomerId,{invoice_settings:{default_payment_method:o}}),await r.user.update({where:{id:e.userId},data:{stripeDefaultPaymentMethodId:o}})),{paymentMethodId:o}}),Vn=y.input(t.object({userId:t.number(),bookingId:t.number(),amount:t.number().positive(),currency:t.string().default("usd"),description:t.string().optional()})).mutation(async({input:e})=>{const n=await r.user.findUnique({where:{id:e.userId}});if(!n?.stripeCustomerId||!n.stripeDefaultPaymentMethodId)throw new Error("User missing saved payment method");const a=await T.paymentIntents.create({amount:Math.round(e.amount*100),currency:e.currency,customer:n.stripeCustomerId,payment_method:n.stripeDefaultPaymentMethodId,off_session:!0,confirm:!0,description:e.description??`Charge for booking #${e.bookingId}`,metadata:{bookingId:e.bookingId.toString()}}),o=a.charges,s=o?.data?.[0]?.payment_method_details?.card?.last4?`Card  ${o.data[0].payment_method_details.card.last4}`:a.payment_method??void 0;return await r.stripePayment.create({data:{bookingId:e.bookingId,stripeIntentId:a.id,amount:e.amount,status:a.status,currency:a.currency,description:a.description??void 0,paymentMethod:s}}),{intentId:a.id,status:a.status}}),Qn=P({createPaymentIntent:xn,capturePayment:Hn,refundPayment:Yn,getBookingPayments:zn,createSetupIntent:Kn,attachPaymentMethodFromSetupIntent:Wn,createChargeWithSavedMethod:Vn}),Gn=g.input(t.object({date:t.date(),description:t.string(),amount:t.number(),category:t.enum(["INCOME","EXPENSE","ASSET","LIABILITY","EQUITY"]),relatedBookingId:t.number().optional()})).mutation(async({input:e})=>await r.accountingEntry.create({data:e})),Xn=g.query(async()=>await r.accountingEntry.findMany()),Zn=g.input(t.object({id:t.number(),date:t.date().optional(),description:t.string().optional(),amount:t.number().optional(),category:t.enum(["INCOME","EXPENSE","ASSET","LIABILITY","EQUITY"]).optional(),relatedBookingId:t.number().optional()})).mutation(async({input:e})=>{const{id:n,...a}=e;return await r.accountingEntry.update({where:{id:n},data:a})}),Jn=g.input(t.object({id:t.number()})).mutation(async({input:e})=>(await r.accountingEntry.delete({where:{id:e.id}}),{success:!0})),K=E.MERCURY_API_BASE||"https://api.mercury.com",W={async getAccounts(){if(!E.MERCURY_API_KEY)return[];const e=await fetch(`${K}/v1/accounts`,{headers:{Authorization:`Bearer ${E.MERCURY_API_KEY}`,"Content-Type":"application/json"}});return e.ok?(await e.json()).accounts||[]:(console.error("Mercury GetAccounts Error:",e.status,await e.text()),[])},async getTransactions(e){if(!E.MERCURY_API_KEY)return[];const n=await fetch(`${K}/v1/account/${e}/transactions`,{headers:{Authorization:`Bearer ${E.MERCURY_API_KEY}`,"Content-Type":"application/json"}});return n.ok?(await n.json()).transactions||[]:(console.error("Mercury GetTransactions Error:",n.status,await n.text()),[])}},ea=g.mutation(async()=>{try{const e=await W.getAccounts();let n=0;for(const a of e){const o=await r.mercuryAccount.upsert({where:{externalId:a.id},create:{externalId:a.id,name:a.name,balance:a.balance,status:"active"},update:{balance:a.balance,name:a.name}}),s=await W.getTransactions(a.id);for(const c of s){if(await r.mercuryTransaction.findUnique({where:{externalId:c.id}}))continue;const i=await r.mercuryTransaction.create({data:{externalId:c.id,accountId:o.id,amount:c.amount,status:c.status,description:c.counterpartyName||c.note||"Mercury Transaction",transactionAt:new Date(c.postedAt||c.createdAt),category:c.amount>0?"INCOME":"EXPENSE"}}),m=Math.abs(c.amount),p=c.amount>0?"INCOME":"EXPENSE",d=await r.accountingEntry.create({data:{date:new Date(c.postedAt||c.createdAt),amount:m,category:p,description:`${c.counterpartyName||"Mercury"} (Sync)`,mercuryTransactionId:i.id}});p==="EXPENSE"&&await r.expense.create({data:{date:new Date(c.postedAt||c.createdAt),amount:m,category:"EXPENSE",description:c.description||c.counterpartyName||"Expense",vendor:c.counterpartyName,accountingEntryId:d.id}}),n++}}return{success:!0,count:n}}catch(e){return console.error("Mercury Sync Error:",e),{success:!1,error:e.message}}}),ta=y.query(async()=>{try{return await z("/v1/accounts")}catch(e){return{accounts:[],error:e?.message||"Mercury accounts unavailable"}}}),na=y.input(t.object({limit:t.number().int().positive().max(100).optional().default(50),page:t.number().int().positive().optional().default(1),startDate:t.string().optional(),endDate:t.string().optional()}).optional()).query(async({input:e})=>{const n=new URLSearchParams,a=e?.limit??50,o=e?.page??1;n.set("per_page",a.toString()),n.set("page",o.toString()),e?.startDate&&n.set("start_date",e.startDate),e?.endDate&&n.set("end_date",e.endDate);let s;try{s=await z(`/v1/transactions?${n.toString()}`)}catch(l){return{transactions:[],error:l?.message||"Mercury transactions unavailable"}}const c=(s?.transactions||s?.data||[]).map(l=>{let i=null;const p=(l.description||l.memo||"").toString().match(/#(\d+)/);return p&&(i=Number(p[1])),{...l,bookingId:i}});if(e?.startDate||e?.endDate){const l=M(e?.startDate,e?.endDate),i=m=>{if(!m)return!1;const p=typeof m=="string"?new Date(m):m;return!(l.start&&p<l.start||l.end&&p>l.end)};return{transactions:c.filter(m=>i(m.transactionAt||m.date||m.created_at))}}return{transactions:c}}),aa=y.input(t.object({startDate:t.date(),endDate:t.date()})).query(async({input:e})=>{const n=await r.accountingEntry.findMany({where:{date:{gte:e.startDate,lte:e.endDate}},include:{expense:!0,mercuryTransaction:!0}}),a=await r.expense.findMany({where:{date:{gte:e.startDate,lte:e.endDate},accountingEntryId:null}});let o=0,s=0;for(const p of n)p.category==="INCOME"?o+=p.amount:p.category==="EXPENSE"&&(s+=p.amount);const c={},l=(p,d,u)=>{const h=p.toISOString().split("T")[0];h&&(c[h]||(c[h]={income:0,expense:0}),u?c[h].income+=d:c[h].expense+=d)};for(const p of n)l(p.date,p.amount,p.category==="INCOME");for(const p of a)l(p.date,p.amount,!1),s+=p.amount;const i=Object.entries(c).map(([p,d])=>({date:p,income:d.income,expense:d.expense,profit:d.income-d.expense})).sort((p,d)=>p.date.localeCompare(d.date)),m=[...n.map(p=>({...p,type:"entry"})),...a.map(p=>({...p,type:"manual",expense:p}))].sort((p,d)=>d.date.getTime()-p.date.getTime());return{totalIncome:o,totalExpense:s,netProfit:o-s,chartData:i,entries:m,manualExpenses:a}}),ra=y.input(t.object({startDate:t.date().optional(),endDate:t.date().optional()})).query(async({input:e})=>{const n=e.startDate||new Date(new Date().getFullYear(),new Date().getMonth(),1),a=e.endDate||new Date,o=await r.booking.findMany({where:{status:"COMPLETED",scheduledDate:{gte:n,lte:a}}}),s=await r.booking.findMany({where:{status:"PENDING",scheduledDate:{gte:n,lte:a}}});return[{key:"billedRevenue",value:o.reduce((l,i)=>l+(i.finalPrice||0),0)},{key:"pendingPayments",value:s.reduce((l,i)=>l+(i.finalPrice||0),0)},{key:"recurringRevenue",value:o.filter(l=>l.serviceFrequency!=="ONE_TIME").reduce((l,i)=>l+(i.finalPrice||0),0)},{key:"monthlyRevenue",value:o.filter(l=>l.serviceFrequency==="MONTHLY").reduce((l,i)=>l+(i.finalPrice||0),0)},{key:"everyOtherWeekRevenue",value:o.filter(l=>l.serviceFrequency==="BIWEEKLY").reduce((l,i)=>l+(i.finalPrice||0),0)},{key:"weeklyRevenue",value:o.filter(l=>l.serviceFrequency==="WEEKLY").reduce((l,i)=>l+(i.finalPrice||0),0)}]}),oa=P({createAccountingEntry:Gn,getAccountingEntries:Xn,updateAccountingEntry:Zn,deleteAccountingEntry:Jn,syncMercuryTransactions:ea,listAccounts:ta,listTransactions:na,getProfitAndLoss:aa,getRevenueMetrics:ra}),ia=g.input(t.object({name:t.string(),email:t.string(),phone:t.string(),source:t.string(),message:t.string(),status:t.string()})).mutation(async({input:e})=>await r.lead.create({data:e})),sa=g.query(async()=>await r.lead.findMany()),ca=g.input(t.object({id:t.number(),name:t.string().optional(),email:t.string().optional(),phone:t.string().optional(),source:t.enum(["GOOGLE_LSA","THUMBTACK","FACEBOOK_AD","REDDIT","NEXTDOOR","WEBSITE","REFERRAL"]).optional(),message:t.string().optional(),status:t.string().optional()})).mutation(async({input:e})=>{const{id:n,...a}=e;return await r.lead.update({where:{id:n},data:a})}),da=g.input(t.object({id:t.number()})).mutation(async({input:e})=>(await r.lead.delete({where:{id:e.id}}),{success:!0})),X=g.input(t.object({transcript:t.string()})).mutation(async({input:e})=>{if(!E.OPENAI_API_KEY)throw new Error("OpenAI API key not configured.");try{const{object:n}=await ge({model:fe("gpt-4o-mini"),schema:t.object({sentiment:t.enum(["positive","neutral","negative"]),actionItems:t.array(t.string()),summary:t.string()}),prompt:`Analyze the following call transcript from a professional cleaning service "Verde Luxe". 
        Identify the overall sentiment, key action items (e.g. scheduling, follow-ups, complaints), and provide a short summary.
        
        Transcript:
        ${e.transcript}`});return n}catch(n){throw console.error("AI analysis failed:",n),new Error("Failed to analyze transcript via AI.")}}),la=y.input(t.object({leadId:t.number()})).mutation(async({input:e})=>{const n=await r.lead.findUnique({where:{id:e.leadId}});if(!n)throw new v({code:"NOT_FOUND",message:"Lead not found"});let a=await r.user.findUnique({where:{email:n.email}});if(!a){const s=Math.random().toString(36).slice(-8),c=await U.hash(s,10),l=n.name.split(" "),i=l[0]||"Unknown",m=l.slice(1).join(" ")||"";a=await r.user.create({data:{email:n.email,firstName:i,lastName:m,phone:n.phone,password:c,role:"CLIENT",temporaryPassword:s}})}const o=await r.booking.create({data:{clientId:a.id,serviceType:"Standard Cleaning",address:"Address Pending",scheduledDate:new Date,scheduledTime:"09:00",status:"PENDING",finalPrice:150}});return await r.lead.update({where:{id:n.id},data:{status:"CONVERTED"}}),{bookingId:o.id,clientId:a.id}}),ua=g.query(async()=>r.leadSourceCategory.findMany({orderBy:{name:"asc"}})),ma=y.input(t.object({name:t.string()})).mutation(async({input:e})=>r.leadSourceCategory.create({data:{name:e.name}})),pa=y.input(t.object({id:t.number()})).mutation(async({input:e})=>r.leadSourceCategory.delete({where:{id:e.id}})),ga=P({createLead:ia,getLeads:sa,updateLead:ca,deleteLead:da,analyzeCallTranscript:X,convertLeadToBooking:la,getLeadSources:ua,createLeadSource:ma,deleteLeadSource:pa}),fa=g.input(t.object({callId:t.number()})).query(async({input:e})=>await r.aITranscript.findFirst({where:{callId:e.callId}})),ya=P({getTranscript:fa,analyzeCallTranscript:X}),ha=g.input(t.object({name:t.string()})).mutation(async({input:e})=>(console.log("Creating campaign..."),{success:!0})),wa=g.input(t.object({campaignId:t.number(),sendAt:t.date()})).mutation(async({input:e})=>(console.log("Scheduling campaign..."),{success:!0})),ba=P({createCampaign:ha,scheduleCampaign:wa}),Ia=g.input(t.object({platform:t.string(),content:t.string(),scheduledAt:t.date().optional()})).mutation(async({input:e})=>await r.socialMediaPost.create({data:{...e,status:e.scheduledAt?"scheduled":"draft"}})),Ea=g.query(async()=>await r.socialMediaPost.findMany()),Na=g.input(t.object({id:t.number(),platform:t.string().optional(),content:t.string().optional(),scheduledAt:t.date().optional(),status:t.string().optional()})).mutation(async({input:e})=>{const{id:n,...a}=e;return await r.socialMediaPost.update({where:{id:n},data:a})}),va=g.input(t.object({id:t.number()})).mutation(async({input:e})=>(await r.socialMediaPost.delete({where:{id:e.id}}),{success:!0})),Ta=P({createSocialMediaPost:Ia,getSocialMediaPosts:Ea,updateSocialMediaPost:Na,deleteSocialMediaPost:va}),Pa=g.input(t.object({path:t.string(),title:t.string(),description:t.string(),keywords:t.string()})).mutation(async({input:e})=>await r.sEOMetadata.create({data:e})),Da=g.query(async()=>await r.sEOMetadata.findMany()),ka=g.input(t.object({id:t.number(),path:t.string().optional(),title:t.string().optional(),description:t.string().optional(),keywords:t.string().optional()})).mutation(async({input:e})=>{const{id:n,...a}=e;return await r.sEOMetadata.update({where:{id:n},data:a})}),Ra=g.input(t.object({id:t.number()})).mutation(async({input:e})=>(await r.sEOMetadata.delete({where:{id:e.id}}),{success:!0})),Aa=g.mutation(async()=>(console.log("Generating sitemap..."),{success:!0})),Oa=P({createSEOMetadata:Pa,getSEOMetadata:Da,updateSEOMetadata:ka,deleteSEOMetadata:Ra,generateSitemap:Aa}),Ca=g.input(t.object({title:t.string(),description:t.string(),videoUrl:t.string(),duration:t.number()})).mutation(async({input:e})=>await r.trainingVideo.create({data:e})),Ma=g.query(async()=>await r.trainingVideo.findMany()),qa=g.input(t.object({id:t.number(),title:t.string().optional(),description:t.string().optional(),videoUrl:t.string().optional(),duration:t.number().optional()})).mutation(async({input:e})=>{const{id:n,...a}=e;return await r.trainingVideo.update({where:{id:n},data:a})}),Ua=g.input(t.object({id:t.number()})).mutation(async({input:e})=>(await r.trainingVideo.delete({where:{id:e.id}}),{success:!0})),Sa=g.input(t.object({cleanerId:t.number(),videoId:t.number(),score:t.number().optional()})).mutation(async({input:e})=>await r.cleanerTrainingProgress.create({data:{...e,completedAt:new Date}})),_a=g.input(t.object({cleanerId:t.number()})).query(async({input:e})=>await r.cleanerTrainingProgress.findMany({where:{cleanerId:e.cleanerId}})),Ba=P({createTrainingVideo:Ca,getTrainingVideos:Ma,updateTrainingVideo:qa,deleteTrainingVideo:Ua,trackTrainingProgress:Sa,getTrainingProgress:_a}),La=g.input(t.object({question:t.string(),answer:t.string(),category:t.string(),order:t.number().optional()})).mutation(async({input:e})=>await r.fAQ.create({data:e})),Fa=g.query(async()=>await r.fAQ.findMany()),ja=g.input(t.object({id:t.number(),question:t.string().optional(),answer:t.string().optional(),category:t.string().optional(),order:t.number().optional()})).mutation(async({input:e})=>{const{id:n,...a}=e;return await r.fAQ.update({where:{id:n},data:a})}),$a=g.input(t.object({id:t.number()})).mutation(async({input:e})=>(await r.fAQ.delete({where:{id:e.id}}),{success:!0})),xa=P({createFaq:La,getFaqs:Fa,updateFaq:ja,deleteFaq:$a}),Ha=y.query(async()=>await r.review.findMany({include:{booking:{include:{client:!0}}},orderBy:{createdAt:"desc"}})),Ya=y.input(t.object({id:t.number()})).mutation(async({input:e})=>(await r.review.delete({where:{id:e.id}}),{success:!0})),za=y.input(t.object({id:t.number(),isPublic:t.boolean().optional(),comment:t.string().optional(),rating:t.number().min(1).max(5).optional()})).mutation(async({input:e})=>{const{id:n,...a}=e;return await r.review.update({where:{id:n},data:a})}),Ka=P({getReviewsAdmin:Ha,deleteReviewAdmin:Ya,updateReviewAdmin:za}),Wa=P({getDailyTasks:y.input(t.object({date:t.date()})).query(async({input:e})=>{const n=new Date(e.date);n.setHours(0,0,0,0);const a=new Date(e.date);return a.setHours(23,59,59,999),await r.manualTask.findMany({where:{date:{gte:n,lte:a}},orderBy:{priority:"desc"},include:{assignedTo:!0}})}),createTask:y.input(t.object({title:t.string().min(1),description:t.string().optional(),date:t.date(),priority:t.enum(["LOW","MEDIUM","HIGH"]).default("MEDIUM"),assignedToId:t.number().optional()})).mutation(async({input:e})=>await r.manualTask.create({data:e})),updateTask:y.input(t.object({id:t.number(),title:t.string().optional(),description:t.string().optional(),status:t.enum(["PENDING","COMPLETED","CANCELLED"]).optional(),priority:t.enum(["LOW","MEDIUM","HIGH"]).optional(),assignedToId:t.number().optional().nullable()})).mutation(async({input:e})=>{const{id:n,...a}=e;return await r.manualTask.update({where:{id:n},data:a})}),deleteTask:y.input(t.object({id:t.number()})).mutation(async({input:e})=>await r.manualTask.delete({where:{id:e.id}}))}),Va=y.input(t.object({horizonDays:t.number().int().positive().max(365).default(120)})).mutation(async({input:e})=>{const n=await r.booking.findMany({where:{serviceFrequency:{not:"ONE_TIME"},status:{not:"CANCELLED"}}});let a=0,o=[];for(const s of n){const c=s.recurrenceId??H.randomUUID();s.recurrenceId||(await r.booking.update({where:{id:s.id},data:{recurrenceId:c,occurrenceNumber:s.occurrenceNumber??1}}),o.push(s.id));const i={WEEKLY:7,BIWEEKLY:14,MONTHLY:30}[s.serviceFrequency]??7,m=new Date(s.scheduledDate),p=new Date;p.setDate(p.getDate()+e.horizonDays);let d=1;for(;;){const u=new Date(m);if(u.setDate(m.getDate()+i*d),u>p)break;if(!await r.booking.findFirst({where:{recurrenceId:c,scheduledDate:u},select:{id:!0}})){const I=await r.booking.findFirst({where:{clientId:s.clientId,scheduledDate:u,scheduledTime:s.scheduledTime},select:{id:!0}}),f=s.cleanerId&&await r.booking.findFirst({where:{scheduledDate:u,scheduledTime:s.scheduledTime,OR:[{cleanerId:s.cleanerId},{cleaners:{some:{cleanerId:s.cleanerId}}}]},select:{id:!0}}),b=s.cleanerId&&await r.timeOffRequest.findFirst({where:{cleanerId:s.cleanerId,status:"APPROVED",startDate:{lte:u},endDate:{gte:u}},select:{id:!0}});if(I){d++;continue}if(f||b){d++;continue}await r.booking.create({data:{clientId:s.clientId,cleanerId:s.cleanerId,serviceType:s.serviceType,scheduledDate:u,scheduledTime:s.scheduledTime,durationHours:s.durationHours,address:s.address,specialInstructions:s.specialInstructions,finalPrice:s.finalPrice,status:s.status,serviceFrequency:s.serviceFrequency,houseSquareFootage:s.houseSquareFootage,basementSquareFootage:s.basementSquareFootage,numberOfBedrooms:s.numberOfBedrooms,numberOfBathrooms:s.numberOfBathrooms,numberOfCleanersRequested:s.numberOfCleanersRequested,cleanerPaymentAmount:s.cleanerPaymentAmount,paymentMethod:s.paymentMethod,paymentDetails:s.paymentDetails,selectedExtras:s.selectedExtras,recurrenceId:c,occurrenceNumber:(s.occurrenceNumber??1)+d}}),a++}d++}}return{created:a,updated:o.length}}),Qa=g.input(t.object({to:t.string().email(),templateType:t.string(),context:t.record(t.any()).optional(),fallbackSubject:t.string().optional(),fallbackBody:t.string().optional()})).mutation(async({input:e})=>{const n=await r.emailTemplate.findFirst({where:{type:e.templateType}}),a=n?.subject||e.fallbackSubject||"Notification";let o=n?.body||e.fallbackBody||"";e.context&&o&&(o=o.replace(/{{(.*?)}}/g,(c,l)=>{const i=l.trim(),m=e.context?.[i];return m!==void 0?String(m):""}));const s=F.createTransport({host:process.env.SMTP_HOST||"localhost",port:Number(process.env.SMTP_PORT||1025),secure:!1});try{await s.sendMail({from:process.env.SMTP_FROM||"no-reply@verdeluxe.com",to:e.to,subject:a,text:o})}catch(c){if(c.code==="ECONNREFUSED")console.warn(" SMTP connection refused. Logging email to console instead:"),console.log(`[Email Mock] To: ${e.to}`),console.log(`[Email Mock] Subject: ${a}`),console.log(`[Email Mock] Body:
${o}`);else throw c}if(n){const c=await r.user.findFirst({where:{email:e.to},select:{id:!0}});c&&await r.emailLog.create({data:{recipientId:c.id,templateId:n.id,sentAt:new Date,status:"sent"}})}return{success:!0}}),Ga=[{type:"booking_create",name:"Booking Created",subject:"Your booking #{{bookingId}} is confirmed",body:"Hi {{clientName}}, your booking #{{bookingId}} for {{scheduledDate}} at {{scheduledTime}} is confirmed."},{type:"booking_cancel",name:"Booking Cancelled",subject:"Your booking #{{bookingId}} has been cancelled",body:"Hi {{clientName}}, your booking #{{bookingId}} for {{scheduledDate}} was cancelled. Contact support if this was unexpected."}],Xa=y.mutation(async()=>{let e=0;for(const n of Ga)await r.emailTemplate.findFirst({where:{type:n.type}})||(await r.emailTemplate.create({data:n}),e++);return{created:e}}),Za=y.input(t.object({bookingId:t.number(),email:t.string().email().optional()})).mutation(async({input:e})=>{const n=await r.booking.findUnique({where:{id:e.bookingId},include:{client:{select:{email:!0,firstName:!0,lastName:!0}}}});if(!n)throw new Error("Booking not found");const a=e.email||n.client?.email;if(!a)throw new Error("No recipient email");const o=F.createTransport({host:process.env.SMTP_HOST||"localhost",port:Number(process.env.SMTP_PORT||1025),secure:!1}),s=`Receipt for booking #${n.id}`,c=`Hi ${n.client?.firstName??""},

Thanks for your booking #${n.id}.
Service: ${n.serviceType}
Date: ${n.scheduledDate.toLocaleDateString()}
Time: ${n.scheduledTime}
Amount: $${(n.finalPrice??0).toFixed(2)}

If you have questions, please reply to this email.`;try{await o.sendMail({from:process.env.SMTP_FROM||"no-reply@verdeluxe.com",to:a,subject:s,text:c})}catch(l){if(l.code==="ECONNREFUSED")console.warn(" SMTP connection refused. Logging email to console instead:"),console.log(`[Email Mock] To: ${a}`),console.log(`[Email Mock] Subject: ${s}`),console.log(`[Email Mock] Body:
${c}`);else throw l}return{success:!0}}),Ja=y.input(t.object({bookingId:t.number(),email:t.string().email().optional()})).mutation(async({input:e})=>{const n=await r.booking.findUnique({where:{id:e.bookingId},include:{client:{select:{email:!0,firstName:!0,lastName:!0}}}});if(!n)throw new Error("Booking not found");const a=e.email||n.client?.email;if(!a)throw new Error("No recipient email");const o=F.createTransport({host:process.env.SMTP_HOST||"localhost",port:Number(process.env.SMTP_PORT||1025),secure:!1}),s=`Invoice for booking #${n.id}`,c=`Hi ${n.client?.firstName??""},

Please find the invoice for your upcoming booking #${n.id}.
Service: ${n.serviceType}
Date: ${n.scheduledDate.toLocaleDateString()}
Time: ${n.scheduledTime}
Balance Due: $${(n.finalPrice??0).toFixed(2)}

You can pay via the client portal. If you have questions, please reply to this email.`;return await o.sendMail({from:process.env.SMTP_FROM||"no-reply@verdeluxe.com",to:a,subject:s,text:c}),{success:!0}}),er=y.input(t.object({scheduledDate:t.string(),scheduledTime:t.string(),cleanerIds:t.array(t.number()).min(1),ignoreBookingId:t.number().optional()})).query(async({input:e})=>{const n=new Date(e.scheduledDate),a=await r.booking.findMany({where:{...e.ignoreBookingId?{id:{not:e.ignoreBookingId}}:{},scheduledDate:n,scheduledTime:e.scheduledTime,OR:[{cleanerId:{in:e.cleanerIds}},{cleaners:{some:{cleanerId:{in:e.cleanerIds}}}}]},select:{id:!0}}),o=await r.timeOffRequest.findMany({where:{cleanerId:{in:e.cleanerIds},status:"APPROVED",startDate:{lte:n},endDate:{gte:n}},select:{id:!0}});return{bookingConflicts:a,timeOffConflicts:o}}),tr=y.input(t.object({clientId:t.number()})).query(async({input:e})=>({booking:await r.booking.findFirst({where:{clientId:e.clientId},orderBy:{scheduledDate:"desc"},select:{id:!0,address:!0,addressLine1:!0,addressLine2:!0,city:!0,state:!0,postalCode:!0,placeId:!0,latitude:!0,longitude:!0,paymentMethod:!0}})})),nr=y.query(async()=>{const e=await r.booking.findMany({where:{cleanerId:null,status:{not:"CANCELLED"}},include:{client:!0},take:5}),n=await r.lead.findMany({where:{status:"new"},orderBy:{createdAt:"desc"},take:5}),a=await r.booking.findMany({where:{status:"COMPLETED"},include:{payments:!0,client:!0}}),o=[];return e.forEach(s=>{o.push({id:`unassigned-${s.id}`,title:"Unassigned Job",description:`${s.serviceType} at ${s.address.split(",")[0]} needs a cleaner.`,time:"Asap",color:"bg-red-100 text-red-700"})}),n.forEach(s=>{o.push({id:`lead-${s.id}`,title:"New Lead",description:`${s.name} sent an inquiry via ${s.source}.`,time:"New",color:"bg-blue-100 text-blue-700"})}),a.forEach(s=>{const c=s.payments.reduce((l,i)=>i.paidAt?l+i.amount:l,0);(s.finalPrice||0)>c&&o.push({id:`charge-${s.id}`,title:"Pending Charge",description:`Completed job for ${s.client.firstName} is ready to be charged.`,time:"Action Required",color:"bg-green-100 text-green-700"})}),o}),ar=g.input(t.object({firstName:t.string().min(1),lastName:t.string().min(1)})).mutation(async({input:e,ctx:n})=>{const a=n.profile?.id;if(!a)throw new Error("Not authenticated");const o=await r.user.update({where:{id:a},data:{firstName:e.firstName,lastName:e.lastName}});return{firstName:o.firstName,lastName:o.lastName,email:o.email}}),rr=g.query(async()=>await r.timeEntry.findMany({where:{endTime:null},include:{user:{select:{id:!0,firstName:!0,lastName:!0}},booking:{select:{id:!0,serviceType:!0,address:!0}}}})),or=y.input(t.object({bookingId:t.number(),cleanerIds:t.array(t.number()),status:t.enum(["PENDING","CONFIRMED","IN_PROGRESS","COMPLETED","CANCELLED"]).optional()})).mutation(async({input:e})=>{const{bookingId:n,cleanerIds:a,status:o}=e;if(!await r.booking.findUnique({where:{id:n}}))throw new Error("Booking not found");if((await r.user.findMany({where:{id:{in:a},role:"CLEANER"},select:{id:!0}})).length!==a.length)throw new Error("One or more invalid cleaner IDs provided");const l=a[0]||null;return await r.booking.update({where:{id:n},data:{cleanerId:l,status:o||"CONFIRMED"}}),await r.bookingCleaner.deleteMany({where:{bookingId:n}}),a.length>0&&await r.bookingCleaner.createMany({data:a.map(i=>({bookingId:n,cleanerId:i})),skipDuplicates:!0}),{success:!0}}),ir=e=>{if(!e)return e;const n=e.replace(/\D/g,"");return n.length===10?`+1${n}`:n.length===11&&n.startsWith("1")?`+${n}`:e.startsWith("+")?e:`+${n}`},sr=g.input(t.object({email:t.string().email("Valid email is required"),password:t.string().min(8,"Password must be at least 8 characters"),role:t.enum(["CLIENT","CLEANER"]).default("CLIENT"),firstName:t.string().optional(),lastName:t.string().optional(),phone:t.string().optional()})).mutation(async({input:e})=>{const n=e.phone?ir(e.phone):void 0;if(await r.user.findFirst({where:{email:{equals:e.email,mode:"insensitive"}}}))throw new v({code:"CONFLICT",message:"Email already registered"});const{data:o,error:s}=await D.auth.admin.createUser({email:e.email,password:e.password,email_confirm:!0,user_metadata:{role:e.role,firstName:e.firstName,lastName:e.lastName,phone:n}}),c=s?.message||"",l=s?.code||"",i=s?.status,m=c.toLowerCase().includes("already registered")||c.toLowerCase().includes("already_registered")||l==="email_exists"||i===422;if(s&&!m)throw console.error("[register] Supabase createUser error (msg):",c),console.error("[register] Supabase createUser error (code):",l,"status:",i),new v({code:"INTERNAL_SERVER_ERROR",message:`Failed to create auth account: ${s.message}`});if(m){console.log("[register] Email already in Supabase Auth but not in DB. Resetting password and creating profile...");const{data:h}=await D.auth.admin.listUsers(),I=h?.users?.find(f=>f.email?.toLowerCase()===e.email.toLowerCase());I&&await D.auth.admin.updateUserById(I.id,{password:e.password})}const p=await r.user.create({data:{email:e.email,password:"",role:e.role,firstName:e.firstName,lastName:e.lastName,phone:n}}),{data:d,error:u}=await D.auth.signInWithPassword({email:e.email,password:e.password});if(u||!d.session)throw console.error("[register] Sign-in after registration failed:",u?.message),new v({code:"INTERNAL_SERVER_ERROR",message:"Account created, but failed to sign in automatically. Please log in manually."});return{token:d.session.access_token,user:{id:p.id,email:p.email,role:p.role,firstName:p.firstName,lastName:p.lastName}}}),Z=P({booking:ze,register:sr,login:Ke,getCurrentUser:We,forgotPassword:Ve,getSchedule:Qe,getPayments:Ge,submitTimeOffRequest:At,getTimeOffRequests:Ot,deleteTimeOffRequest:Ct,updateTimeOffRequest:Mt,getUpcomingBookings:Xe,getAllBookings:Ze,getAllBookingsAdmin:Je,getAllUsersAdmin:et,getCustomerDetailsAdmin:tt,getCustomerPaymentMethods:nt,getSession:at,createBookingAdmin:rt,updateBookingAdmin:ot,deleteBookingAdmin:it,getBookingStatsAdmin:st,getRevenueReport:ct,getQuizSubmissions:dt,createUserAdmin:lt,updateUserAdmin:ut,deleteUserAdmin:mt,getAllTimeOffRequests:qt,updateTimeOffRequestStatus:Ut,clearTimeOffRequestAdmin:St,generateRecurrences:Va,sendTransactionalEmail:Qa,seedDefaultEmailTemplates:Xa,sendBookingReceipt:Za,sendBookingInvoice:Ja,getAvailabilityConflicts:er,getLatestBookingForClient:tr,getAdminTasks:nr,updateProfile:ar,getActiveTimeEntries:rr,assignCleaners:or,createChecklistTemplate:pt,getChecklistTemplates:gt,updateChecklistTemplate:ft,deleteChecklistTemplate:yt,getBookingChecklist:ht,updateBookingChecklistItem:wt,getPricingRules:bt,createPricingRule:It,updatePricingRule:Et,deletePricingRule:Nt,calculateBookingPrice:vt,getBookingAvailability:Tt,getCleanerAvailabilityDetails:Pt,generateToken:Dt,makeCall:kt,getCallHistory:Rt,time:$t,messaging:Xt,system:Jt,availability:an,photos:ln,bulk:gn,email:bn,payments:Bn,sms:Fn,documents:$n,stripe:Qn,accounting:oa,crm:ga,ai:ya,marketing:ba,social:Ta,seo:Oa,training:Ba,faq:xa,reviews:Ka,tasks:Wa});ye(Z);const Tr=ae(e=>{const n=re(e);return n?oe({endpoint:"/trpc",req:n,router:Z,async createContext(){const a=n.headers.get("authorization"),o=a?.toLowerCase().startsWith("bearer ")?a.slice(7):null;console.log(`[tRPC] Request to endpoint from handler. Token present: ${!!o}`),o||console.log(`[tRPC] No token found in authorization header: "${a}"`);let s=null,c=null;if(o){let l=null,i=null;try{const{data:u}=await D.auth.getUser(o);l=u?.user?.email??null,i=u?.user?.id??null}catch(u){console.error("Supabase auth.getUser failed, attempting decode fallback",u)}const m=l||i?null:(()=>{try{return JSON.parse(Buffer.from(o.split(".")[1]??"","base64").toString("utf8"))}catch{return null}})(),p=l??m?.email??null,d=i??"";if(p){console.log(`[tRPC] Looking up dbUser for email: "${p}" (case-insensitive)`),s={id:d,email:p};const u=await r.user.findFirst({where:{email:{equals:p,mode:"insensitive"}},select:{id:!0,email:!0,role:!0,firstName:!0,lastName:!0,adminPermissions:!0}});u?(console.log(`[tRPC] dbUser found. ID: ${u.id}, Role: ${u.role}`),c=u):console.log(`[tRPC] No dbUser found for email: "${p}"`)}else console.log("[tRPC] No email found in token/decoded.")}else console.log("[tRPC] No token present in request.");return{authUser:s,profile:c,token:o}},onError({error:a,path:o}){console.error(`tRPC error on '${o}':`,a)}}):new Response("No request",{status:400})});export{Tr as default};
